===== docker-compose.yml =====
services:db:build:context:.dockerfile:Dockerfile-postgresqlvolumes:-postgres_data:/var/lib/postgresql/dataports:-"5432:5432"environment:-POSTGRES_DB=db-POSTGRES_USER=fabriciopa-POSTGRES_PASSWORD=5472adminer:build:context:.dockerfile:Dockerfile-adminerports:-"8080:8080"depends_on:-dbweb:build:context:.dockerfile:Dockerfile-djangocommand:pythonmanage.pyrunserver0.0.0.0:8000volumes:-./ft_trans:/codeports:-"8000:8000"depends_on:-dbenvironment:-DATABASE_URL=postgres://fabriciopa:5472@db/dbchat:build:context:.dockerfile:Dockerfile-chatports:-"3000:3000"depends_on:-webgame:build:context:.dockerfile:./ft_trans/pong/templates/js/game/Dockerfileports:-"4000:4000"volumes:-./ft_trans/pong/templates/js/game:/usr/src/appdepends_on:-webvolumes:postgres_data:
===== init-database.sh =====
#!/bin/bashset-e#FonctionpourexécuterdescommandesSQLpsql_execute(){psql-vON_ERROR_STOP=1--username"$POSTGRES_USER"--dbname"$POSTGRES_DB"-c"$1"}#Vérifiersilabasededonnéesexistedéjàifpsql_execute"\l"|grep-q"$POSTGRES_DB";thenecho"Labasededonnées$POSTGRES_DBexistedéjà.Utilisationdelabaseexistante."elseecho"Labasededonnées$POSTGRES_DBn'existepas.Créationdelabasededonnées..."#Créerlabasededonnéespsql_execute"CREATEDATABASE$POSTGRES_DB;"#Seconnecteràlanouvellebasededonnéespsql_execute"\c$POSTGRES_DB"#ExécuterlescriptSQLpourcréerlestablespsql-vON_ERROR_STOP=1--username"$POSTGRES_USER"--dbname"$POSTGRES_DB"-f/docker-entrypoint-initdb.d/init-database.sqlecho"Basededonnées$POSTGRES_DBcrééeetinitialiséeavecsuccès."fi
===== init-database.sql =====
--InitialisationdelabasededonnéespourleprojetPong--SuppressiondestablesexistantessiellesexistentDROPTABLEIFEXISTSusersCASCADE;DROPTABLEIFEXISTSfriendsCASCADE;DROPTABLEIFEXISTSmatchesCASCADE;DROPTABLEIFEXISTStournamentsCASCADE;DROPTABLEIFEXISTStournament_participantsCASCADE;DROPTABLEIFEXISTSprivate_messagesCASCADE;DROPTABLEIFEXISTSuser_settingsCASCADE;DROPTABLEIFEXISTSusersCASCADE;DROPTABLEIFEXISTSauth_userCASCADE;DROPTABLEIFEXISTSdjango_migrationsCASCADE;
===== Dockerfile-adminer =====
FROMadminer:latest#Setthedefaulttheme(optional)ENVADMINER_DESIGNdarcula#Youcanaddcustomizationshereifneeded#Forexample,toaddplugins:#ADDhttps://raw.githubusercontent.com/vrana/adminer/master/plugins/plugin.php/var/www/html/plugins/#ADDhttps://raw.githubusercontent.com/vrana/adminer/master/plugins/login-servers.php/var/www/html/plugins/EXPOSE8080
===== Dockerfile-django =====
#UseanofficialPythonruntimeasaparentimageFROMpython:3.10#SetenvironmentvariablesENVPYTHONDONTWRITEBYTECODE1ENVPYTHONUNBUFFERED1#SetworkdirectoryWORKDIR/code#InstalldependenciesCOPYrequirements.txt/code/RUNpipinstall--upgradepipRUNpipinstall-rrequirements.txt#CopyprojectCOPY./code/#Copyentrypointscript#COPYentrypoint.sh/code/entrypoint.sh#RUNchmod+x/code/entrypoint.sh#ExposetheporttheapprunsonEXPOSE8000#ENTRYPOINT["/code/entrypoint.sh"]#RuntheapplicationCMD["python","manage.py","runserver","0.0.0.0:8000"]
===== Dockerfile-postgresql =====
FROMpostgres:16#Copiezlescriptd'initialisationCOPYinit-database.sh/docker-entrypoint-initdb.d/COPYinit-database.sql/docker-entrypoint-initdb.d/#Définissezlesvariablesd'environnementENVPOSTGRES_DB=dbENVPOSTGRES_USER=fabriciopaENVPOSTGRES_PASSWORD=5472#ExposezleportPostgreSQLEXPOSE5432
===== ./ft_trans/ft_trans/urls.py =====
"""URLconfigurationforft_transproject.The`urlpatterns`listroutesURLstoviews.Formoreinformationpleasesee:https://docs.djangoproject.com/en/5.0/topics/http/urls/Examples:Functionviews1.Addanimport:frommy_appimportviews2.AddaURLtourlpatterns:path('',views.home,name='home')Class-basedviews1.Addanimport:fromother_app.viewsimportHome2.AddaURLtourlpatterns:path('',Home.as_view(),name='home')IncludinganotherURLconf1.Importtheinclude()function:fromdjango.urlsimportinclude,path2.AddaURLtourlpatterns:path('blog/',include('blog.urls'))"""fromdjango.contribimportadminfromdjango.urlsimportpath,includeurlpatterns=[path('admin/',admin.site.urls),path('',include('pong.urls')),]
===== ./ft_trans/ft_trans/asgi.py =====
"""ASGIconfigforft_transproject.ItexposestheASGIcallableasamodule-levelvariablenamed``application``.Formoreinformationonthisfile,seehttps://docs.djangoproject.com/en/5.0/howto/deployment/asgi/"""importosfromdjango.core.asgiimportget_asgi_applicationos.environ.setdefault('DJANGO_SETTINGS_MODULE','ft_trans.settings')application=get_asgi_application()
===== ./ft_trans/ft_trans/wsgi.py =====
"""WSGIconfigforft_transproject.ItexposestheWSGIcallableasamodule-levelvariablenamed``application``.Formoreinformationonthisfile,seehttps://docs.djangoproject.com/en/5.0/howto/deployment/wsgi/"""importosfromdjango.core.wsgiimportget_wsgi_applicationos.environ.setdefault('DJANGO_SETTINGS_MODULE','ft_trans.settings')application=get_wsgi_application()
===== ./ft_trans/ft_trans/settings.py =====
"""Djangosettingsforft_transproject.Generatedby'django-adminstartproject'usingDjango5.0.7.Formoreinformationonthisfile,seehttps://docs.djangoproject.com/en/5.0/topics/settings/Forthefulllistofsettingsandtheirvalues,seehttps://docs.djangoproject.com/en/5.0/ref/settings/"""frompathlibimportPathfromdatetimeimporttimedelta#Buildpathsinsidetheprojectlikethis:BASE_DIR/'subdir'.BASE_DIR=Path(__file__).resolve().parent.parent#Quick-startdevelopmentsettings-unsuitableforproduction#Seehttps://docs.djangoproject.com/en/5.0/howto/deployment/checklist/#SECURITYWARNING:keepthesecretkeyusedinproductionsecret!SECRET_KEY='django-insecure-69i@hqe0&ym6z6o7nho0vxoqwn24bg4a4f&_6fxqdkh9s5!ym5'#SECURITYWARNING:don'trunwithdebugturnedoninproduction!DEBUG=TrueALLOWED_HOSTS=[]APPEND_SLASH=FalseALLOWED_HOSTS=['localhost','127.0.0.1','web']#ApplicationdefinitionINSTALLED_APPS=['django.contrib.admin','django.contrib.auth','django.contrib.contenttypes','django.contrib.sessions','django.contrib.messages','django.contrib.staticfiles','rest_framework','rest_framework.authtoken','corsheaders','rest_framework_simplejwt','pong',]MIDDLEWARE=['django.middleware.security.SecurityMiddleware','django.contrib.sessions.middleware.SessionMiddleware','corsheaders.middleware.CorsMiddleware','django.middleware.common.CommonMiddleware','django.middleware.csrf.CsrfViewMiddleware','django.contrib.auth.middleware.AuthenticationMiddleware','django.contrib.messages.middleware.MessageMiddleware','django.middleware.clickjacking.XFrameOptionsMiddleware',]CORS_ALLOWED_ORIGINS=["http://localhost:4000","http://localhost:8000",]CORS_ALLOW_CREDENTIALS=TrueCSRF_TRUSTED_ORIGINS=["http://localhost:4000",]ROOT_URLCONF='ft_trans.urls'TEMPLATES=[{'BACKEND':'django.template.backends.django.DjangoTemplates','DIRS':[],'APP_DIRS':True,'OPTIONS':{'context_processors':['django.template.context_processors.debug','django.template.context_processors.request','django.contrib.auth.context_processors.auth','django.contrib.messages.context_processors.messages',],},},]WSGI_APPLICATION='ft_trans.wsgi.application'#Database#https://docs.djangoproject.com/en/5.0/ref/settings/#databasesDATABASES={'default':{'ENGINE':'django.db.backends.postgresql_psycopg2','NAME':'db','USER':'fabriciopa','PASSWORD':'5472','HOST':'db','PORT':'5432',}}#Passwordvalidation#https://docs.djangoproject.com/en/5.0/ref/settings/#auth-password-validatorsAUTH_PASSWORD_VALIDATORS=[{'NAME':'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',},{'NAME':'django.contrib.auth.password_validation.MinimumLengthValidator',},{'NAME':'django.contrib.auth.password_validation.CommonPasswordValidator',},{'NAME':'django.contrib.auth.password_validation.NumericPasswordValidator',},]#Internationalization#https://docs.djangoproject.com/en/5.0/topics/i18n/LANGUAGE_CODE='en-us'TIME_ZONE='UTC'USE_I18N=TrueUSE_TZ=True#Staticfiles(CSS,JavaScript,Images)#https://docs.djangoproject.com/en/5.0/howto/static-files/STATIC_URL='static/'STATICFILES_DIRS=[BASE_DIR/'pong/templates/',]#Defaultprimarykeyfieldtype#https://docs.djangoproject.com/en/5.0/ref/settings/#default-auto-fieldDEFAULT_AUTO_FIELD='django.db.models.BigAutoField'REST_FRAMEWORK={'DEFAULT_AUTHENTICATION_CLASSES':['rest_framework_simplejwt.authentication.JWTAuthentication',],}SIMPLE_JWT={#forjwt'ACCESS_TOKEN_LIFETIME':timedelta(minutes=60),'REFRESH_TOKEN_LIFETIME':timedelta(days=1),}AUTH_USER_MODEL='pong.CustomUser'AUTHENTICATION_BACKENDS=['django.contrib.auth.backends.ModelBackend',]LOGGING={'version':1,'disable_existing_loggers':False,'handlers':{'console':{'class':'logging.StreamHandler',},},'root':{'handlers':['console'],'level':'INFO',},}#asecuriseravecimportosetos.getenv('FT_CLIENT_ID')etos.getenv('FT_CLIENT_SECRET')FT_CLIENT_ID='u-s4t2ud-0bdec356ea53d09b3992d0f90a9e4b9cdf8d0659d321388f9ba8ee3a41448165'FT_CLIENT_SECRET='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'
===== ./ft_trans/pong/urls.py =====
fromdjango.urlsimportpath,includefrom.importviewsfromrest_framework.routersimportDefaultRouterfromrest_framework_simplejwt.viewsimportTokenObtainPairView,TokenRefreshViewurlpatterns=[path('api/auth/42/',views.auth_42_redirect,name='auth_42_redirect'),path('api/auth/42/callback/',views.auth_42_callback,name='auth_42_callback'),path('api/auth/42/login/',views.auth_42_login_redirect,name='auth_42_login_redirect'),path('api/auth/42/login/callback/',views.auth_42_login_callback,name='auth_42_login_callback'),path('api/content/',views.content,name='content'),path('api/set-csrf-token/',views.set_csrf_token,name='set_csrf_token'),path('api/token/',TokenObtainPairView.as_view(),name='token_obtain_pair'),path('api/token/refresh/',TokenRefreshView.as_view(),name='token_refresh'),path('api/verify-token/',views.verify_token,name='verify_token'),path('api/create_user/',views.create_user,name='create_user'),path('api/register/',views.register_view,name='register'),path('api/login/',views.login_view,name='login'),path('api/friend-requests',views.friend_requests,name='friend_requests'),path('api/user/<str:display_name>/',views.get_user_by_display_name,name='get_user_by_display_name'),path('api/user/stats/',views.get_user_stats,name='get_user_stats'),path('api/update-online-status/',views.update_online_status,name='update_online_status'),path('api/friends/',views.get_friend_list,name='get_friend_list'),path('api/send-friend-request/',views.send_friend_request,name='send_friend_request'),path('api/accept-friend-request/',views.accept_friend_request,name='accept_friend_request'),path('api/reject-friend-request/',views.reject_friend_request,name='reject_friend_request'),path('api/get-friend-requests/',views.get_friend_requests,name='get_friend_requests'),path('api/update-user-settings/',views.update_user_settings,name='update_user_settings'),path('api/check-friend-request/<str:username>/',views.check_friend_request,name='check_friend_request'),path('api/profile/<str:username>/',views.user_profile,name='user_profile'),path('api/user-ping/',views.user_ping,name='user_ping'),path('api/users/display_name/<str:display_name>/update_stats/',views.update_user_stats,name='update_user_stats'),path('api/save-match-result/',views.save_match_result,name='save_match_result'),path('api/get-recent-matches/<str:username>/',views.get_recent_matches,name='get_recent_matches'),path('<path:path>',views.index,name='catch_all'),path('',views.index,name='index'),]
===== ./ft_trans/pong/views.py =====
importjsonimportloggingimportrequestsfromdjango.httpimportJsonResponsefromdjango.contrib.auth.modelsimportUserfromdjango.contrib.authimportauthenticate,loginfromdjango.views.decorators.csrfimportensure_csrf_cookiefromdjango.shortcutsimportrenderfromdjango.middleware.csrfimportget_tokenfromrest_framework_simplejwt.tokensimportRefreshTokenfromrest_framework.decoratorsimportactionfromrest_framework.responseimportResponsefromdjango.dbimportIntegrityErrorfromdjango.shortcutsimportredirectfromrest_frameworkimportviewsets,statusfrom.serializersimportCustomUserSerializerlogger=logging.getLogger(__name__)fromdjango.utilsimporttimezonefromdjango.contrib.authimportget_user_modelfrom.modelsimportCustomUser,Friendship,FriendRequest,MatchHistoryfromdjango.contrib.auth.hashersimportcheck_password,make_passwordfromdjango.views.decorators.httpimportrequire_GETfromdjango.confimportsettingsfromrest_framework.decoratorsimportapi_view,permission_classesfromrest_framework.permissionsimportIsAuthenticatedfromdjango.views.decorators.httpimportrequire_http_methodsfrom.serializersimportFriendshipSerializerfromdjango.core.exceptionsimportValidationErrorfromdjango.core.files.imagesimportget_image_dimensionsfromdjango.core.validatorsimportvalidate_emailfromPILimportImagefromdjango.views.decorators.csrfimportcsrf_exemptfromdjango.contrib.auth.decoratorsimportlogin_requiredUser=get_user_model()defcreate_user(request):ifrequest.method=='POST':data=json.loads(request.body)user=User.create_user(data['username'],data=data['password'])returnJsonResponse({'message':'usercreatedwithid'+str(user.id)},status=201)else:returnJsonResponse({'error':'invalidrequest'},status=400)defindex(request,path=''):returnrender(request,'index.html')@permission_classes([IsAuthenticated])classCustomUserViewSet(viewsets.ModelViewSet):queryset=CustomUser.objects.all()serializer_class=CustomUserSerializer@action(detail=False,methods=['put'],url_path='display_name/(?P<display_name>[^/.]+)/update_stats')defupdate_stats_by_display_name(self,request,display_name=None):user=CustomUser.objects.get(display_name=display_name)data=request.datauser.is_online=data.get('is_online',user.is_online)user.wins=data.get('wins',user.wins)user.losses=data.get('losses',user.losses)user.save()serializer=self.get_serializer(user)returnResponse(serializer.data,status=status.HTTP_200_OK)@ensure_csrf_cookiedeflogin_view(request):ifrequest.method=='POST':try:data=json.loads(request.body)username=data.get('username')password=data.get('password')user=authenticate(request,username=username,password=password)ifuserisnotNone:login(request,user)refresh=RefreshToken.for_user(user)returnJsonResponse({'success':True,'message':'Connectionsuccessful','access':str(refresh.access_token),'refresh':str(refresh),'username':user.username,'display_name':user.display_name,'avatar_url':user.avatar_url,},status=200)else:returnJsonResponse({'success':False,'message':'Invalidcredentials'},status=401)exceptjson.JSONDecodeError:returnJsonResponse({'success':False,'message':'InvalidJSONdata'},status=400)exceptExceptionase:logger.error(f"Errorduringconnection:{str(e)}")returnJsonResponse({'success':False,'message':'Anerroroccurred'},status=500)returnJsonResponse({'success':False,'message':'Methodnotallowed'},status=405)defcontent(request):returnJsonResponse({'message':'contentpage'},status=200)@ensure_csrf_cookiedefregister_view(request):ifrequest.method=='POST':try:data=json.loads(request.body)username=data.get('username')email=data.get('email')password=data.get('password')avatar_url=data.get('avatar_url')ifUser.objects.filter(username=username).exists():returnJsonResponse({'success':False,'error':'Thisusernameisalreadytaken.'},status=400)ifUser.objects.filter(email=email).exists():returnJsonResponse({'success':False,'error':'Thisemailisalreadyinuse.'},status=400)user=User.objects.create_user(username=username,email=email,password=password,avatar_url=avatar_url,display_name=username,wins=0,losses=0,is_online=False,)refresh=RefreshToken.for_user(user)returnJsonResponse({'success':True,'message':'Comptecrééavecsuccès.','access':str(refresh.access_token),'refresh':str(refresh),},status=201)exceptIntegrityErrorase:error_message=str(e)if'users_display_name_key'inerror_message:returnJsonResponse({'success':False,'error':'Thisdisplaynameisalreadyinuse.'},status=400)elif'users_email_key'inerror_message:returnJsonResponse({'success':False,'error':'Thisemailisalreadyinuse.'},status=400)else:returnJsonResponse({'success':False,'error':'Anerroroccurredduringregistration.'},status=500)exceptExceptionase:logger.error(f"Errorduringregistration:{str(e)}")returnJsonResponse({'success':False,'error':'Anerroroccurred.'},status=500)returnJsonResponse({'success':False,'error':'Methodnotallowed.'},status=405)@ensure_csrf_cookiedefset_csrf_token(request):token=get_token(request)logger.info(f"CSRFTokengenerated:{token}")returnJsonResponse({'csrfToken':get_token(request)})@api_view(['GET','POST'])@permission_classes([IsAuthenticated])deffriend_requests(request):pass@require_GET@permission_classes([IsAuthenticated])defget_user_by_display_name(request,display_name):try:user=User.objects.get(display_name=display_name)user_data={'username':user.username,'email':user.email,'avatar_url':user.avatar_url,'display_name':user.display_name,'is_online':user.is_online,'wins':user.wins,'losses':user.losses,}returnJsonResponse({'success':True,'user':user_data})exceptUser.DoesNotExist:logger.error(f"Usernotfound:{display_name}")returnJsonResponse({'success':False,'error':'Usernotfound'},status=404)exceptExceptionase:logger.error(f"Errorfetchinguserbydisplayname:{str(e)}")returnJsonResponse({'success':False,'error':str(e)},status=500)@require_http_methods(["GET"])@permission_classes([IsAuthenticated])defget_user_stats(request):user=request.useruser_data={'username':user.username,'email':user.email,'avatar_url':user.avatar_url,'display_name':user.display_name,'is_online':user.is_online,'wins':user.wins,'losses':user.losses,}returnJsonResponse({'success':True,'user':user_data})defauth_42_redirect(request):redirect_uri=request.build_absolute_uri('/api/auth/42/callback/')returnredirect(f'https://api.intra.42.fr/oauth/authorize?client_id={settings.FT_CLIENT_ID}&redirect_uri={redirect_uri}&response_type=code')@csrf_exemptdefauth_42_callback(request):try:code=request.GET.get('code')logger.info(f"Codereçu:{code}")ifnotcode:raiseValueError('Aucuncodefourni')redirect_uri=request.build_absolute_uri('/api/auth/42/callback/')logger.info(f"URIderedirection:{redirect_uri}")token_response=requests.post('https://api.intra.42.fr/oauth/token',data={'grant_type':'authorization_code','client_id':settings.FT_CLIENT_ID,'client_secret':settings.FT_CLIENT_SECRET,'code':code,'redirect_uri':redirect_uri})logger.info(f"Réponsedutoken:{token_response.status_code}-{token_response.text}")iftoken_response.status_code!=200:raiseValueError(f'Échecdel\'obtentiondutokend\'accès:{token_response.text}')access_token=token_response.json().get('access_token')logger.info(f"Tokend'accèsobtenu:{access_token}")ifnotaccess_token:raiseValueError('Tokend\'accèsnonobtenu')#Récupérationdesinformationsdel'utilisateuruser_info_response=requests.get('https://api.intra.42.fr/v2/me',headers={'Authorization':f'Bearer{access_token}'})logger.info(f"Réponsedesinformationsutilisateur:{user_info_response.status_code}-{user_info_response.text}")ifuser_info_response.status_code!=200:raiseValueError(f'Échecdelarécupérationdesinformationsutilisateur:{user_info_response.text}')user_info=user_info_response.json()logger.info(f"Informationsutilisateurrécupérées:{user_info}")username=user_info.get('login')email=user_info.get('email','')display_name=user_info.get('displayname',username)avatar_url=user_info.get('image',{}).get('link','')ifnotusername:raiseValueError('Nomd\'utilisateurnontrouvédanslesinformationsrécupérées')user,created=CustomUser.objects.get_or_create(username=username,defaults={'email':email,'avatar_url':avatar_url,'display_name':display_name,})logger.info(f"Utilisateur{'créé'ifcreatedelse'existant'}:{user.username}")ifnotcreated:user.email=emailuser.avatar_url=avatar_urluser.display_name=display_nameuser.save()logger.info(f"Informationsutilisateurmisesàjourpour:{user.username}")login(request,user)logger.info(f"Utilisateurconnecté:{user.username}")returnredirect('/?auth_success=true')exceptExceptionase:logger.error(f"Erreurlorsdel'authentificationavec42:{str(e)}")returnJsonResponse({'error':str(e)},status=500)@api_view(['GET'])@permission_classes([IsAuthenticated])defuser_profile(request,display_name):logger.info(f"Tentatived'accèsauprofilde{display_name}")logger.info(f"Utilisateurauthentifié:{request.user}")try:user=User.objects.get(display_name=display_name)profile_data={#'username':user.username,'display_name':user.display_name,'avatar_url':user.avatar_url,'wins':user.wins,'losses':user.losses,'is_online':user.is_online,#Ajoutezd'autreschampsselonvosbesoins}returnJsonResponse({'success':True,'profile':profile_data})exceptUser.DoesNotExist:returnJsonResponse({'success':False,'error':'Utilisateurnontrouvé'},status=404)@api_view(['POST'])@permission_classes([IsAuthenticated])defsend_friend_request(request):to_username=request.data.get('to_username')try:to_user=CustomUser.objects.get(username=to_username)ifFriendship.objects.filter(user=request.user,friend=to_user).exists():returnJsonResponse({'success':False,'message':'Youarealreadyfriendswiththisuser.'},status=400)ifFriendRequest.objects.filter(from_user=request.user,to_user=to_user,status='pending').exists():returnJsonResponse({'success':False,'message':'Afriendrequestisalreadypendingforthisuser.'},status=400)FriendRequest.objects.create(from_user=request.user,to_user=to_user)returnJsonResponse({'success':True,'message':'Friendrequestsent'})exceptCustomUser.DoesNotExist:returnJsonResponse({'success':False,'message':'Usernotfound'},status=404)@api_view(['POST'])@permission_classes([IsAuthenticated])defaccept_friend_request(request):request_id=request.data.get('request_id')try:friend_request=FriendRequest.objects.get(id=request_id,to_user=request.user,status='pending')friend_request.status='accepted'friend_request.save()Friendship.objects.create(user=request.user,friend=friend_request.from_user)Friendship.objects.create(user=friend_request.from_user,friend=request.user)returnJsonResponse({'success':True,'message':'Friendrequestaccepted'})exceptFriendRequest.DoesNotExist:returnJsonResponse({'success':False,'message':'Friendrequestnotfound'},status=404)@api_view(['POST'])@permission_classes([IsAuthenticated])defreject_friend_request(request):request_id=request.data.get('request_id')try:friend_request=FriendRequest.objects.get(id=request_id,to_user=request.user,status='pending')friend_request.status='rejected'friend_request.save()returnJsonResponse({'success':True,'message':'Friendrequestrejected'})exceptFriendRequest.DoesNotExist:returnJsonResponse({'success':False,'message':'Friendrequestnotfound'},status=404)@api_view(['GET'])@permission_classes([IsAuthenticated])defget_friend_requests(request):friend_requests=FriendRequest.objects.filter(to_user=request.user,status='pending')requests_data=[{'id':fr.id,'from_username':fr.from_user.username,'created_at':fr.created_at}forfrinfriend_requests]returnJsonResponse({'success':True,'friend_requests':requests_data})@api_view(['POST'])@permission_classes([IsAuthenticated])defupdate_user_settings(request):logger.info(f"Requêtereçuepourupdate_user_settings:{request.data}")logger.info(f"Utilisateurauthentifié:{request.user}")user=request.userdisplay_name=request.data.get('displayName')email=request.data.get('email')avatar=request.FILES.get('avatar')ifdisplay_name:ifCustomUser.objects.filter(display_name=display_name).exclude(id=user.id).exists():returnJsonResponse({'success':False,'message':'Thisdisplaynameisalreadyinuse.'},status=400)user.display_name=display_nameifemail:try:validate_email(email)ifCustomUser.objects.filter(email=email).exclude(id=user.id).exists():returnJsonResponse({'success':False,'message':'Thisemailisalreadyinuse.'},status=400)user.email=emailexceptValidationError:returnJsonResponse({'success':False,'message':'Invalidemail.'},status=400)ifavatar:ifavatar.size>5*1024*1024:#5MBreturnJsonResponse({'success':False,'message':'Thefileistoolarge.Maximumsizeis5MB.'},status=400)try:img=Image.open(avatar)width,height=img.sizeifwidth<100orheight<100orwidth>1000orheight>1000:returnJsonResponse({'success':False,'message':'Imagedimensionsmustbebetween100x100and1000x1000pixels.'},status=400)except:returnJsonResponse({'success':False,'message':'Invalidimagefile.'},status=400)user.avatar_url=avataruser.save()returnJsonResponse({'success':True,'message':'Settingsupdatedsuccessfully.'})@api_view(['GET'])@permission_classes([IsAuthenticated])defcheck_friendship_status(request,username):try:target_user=CustomUser.objects.get(username=username)is_friend=Friendship.objects.filter(user=request.user,friend=target_user).exists()request_sent=FriendRequest.objects.filter(from_user=request.user,to_user=target_user,status='pending').exists()returnJsonResponse({'is_friend':is_friend,'request_sent':request_sent})exceptCustomUser.DoesNotExist:returnJsonResponse({'error':'Utilisateurnontrouvé'},status=404)defauth_42_login_redirect(request):redirect_uri=request.build_absolute_uri('/api/auth/42/login/callback/')returnredirect(f'https://api.intra.42.fr/oauth/authorize?client_id={settings.FT_CLIENT_ID}&redirect_uri={redirect_uri}&response_type=code')defauth_42_login_callback(request):code=request.GET.get('code')ifnotcode:returnJsonResponse({'error':'Codenonfourni'},status=400)redirect_uri=request.build_absolute_uri('/api/auth/42/login/callback/')token_response=requests.post('https://api.intra.42.fr/oauth/token',data={'grant_type':'authorization_code','client_id':settings.FT_CLIENT_ID,'client_secret':settings.FT_CLIENT_SECRET,'code':code,'redirect_uri':redirect_uri})iftoken_response.status_code!=200:returnJsonResponse({'error':'Échecdel\'obtentiondutoken'},status=400)access_token=token_response.json().get('access_token')user_info=requests.get('https://api.intra.42.fr/v2/me',headers={'Authorization':f'Bearer{access_token}'}).json()username=user_info.get('login')try:user=CustomUser.objects.get(username=username)exceptCustomUser.DoesNotExist:returnJsonResponse({'error':'Utilisateurnontrouvé'},status=404)login(request,user)refresh=RefreshToken.for_user(user)returnJsonResponse({'success':True,'message':'Connexionréussie','access':str(refresh.access_token),'refresh':str(refresh),'username':user.username,'display_name':user.display_name,'avatar_url':user.avatar_url,})@api_view(['POST'])@permission_classes([IsAuthenticated])defverify_token(request):returnJsonResponse({'success':True,'message':'Tokenvalide'})@api_view(['GET'])@permission_classes([IsAuthenticated])defget_friend_list(request):friendships=Friendship.objects.filter(user=request.user)friends_data=[]forfriendshipinfriendships:friend=friendship.friendfriends_data.append({'username':friend.username,'display_name':friend.display_name,'is_online':friend.is_online,'avatar_url':friend.avatar_url})returnJsonResponse({'friends':friends_data})@api_view(['POST'])@permission_classes([IsAuthenticated])defuser_ping(request):user=request.useruser.last_activity=timezone.now()user.save()returnJsonResponse({'status':'success'})@api_view(['POST'])@permission_classes([IsAuthenticated])defupdate_online_status(request):user=request.useruser.is_online=Trueuser.last_activity=timezone.now()user.save()returnResponse({'status':'success'})#Gardezlafonctionutilitaireséparéesinécessairedefupdate_offline_status():five_minutes_ago=timezone.now()-timezone.timedelta(minutes=5)CustomUser.objects.filter(last_activity__lt=five_minutes_ago,is_online=True).update(is_online=False)@api_view(['GET'])@permission_classes([IsAuthenticated])defcheck_friend_request(request,username):try:target_user=CustomUser.objects.get(username=username)is_friend=Friendship.objects.filter(user=request.user,friend=target_user).exists()request_sent=FriendRequest.objects.filter(from_user=request.user,to_user=target_user,status='pending').exists()returnJsonResponse({'is_friend':is_friend,'request_sent':request_sent})exceptCustomUser.DoesNotExist:returnJsonResponse({'error':'Utilisateurnontrouvé'},status=404)@api_view(['PUT'])@permission_classes([IsAuthenticated])defupdate_user_stats(request,display_name):try:user=CustomUser.objects.get(display_name=display_name)data=request.datauser.wins=data.get('wins',user.wins)user.losses=data.get('losses',user.losses)user.is_online=data.get('is_online',user.is_online)user.save()returnResponse({'success':True,'message':'Userstatsupdatedsuccessfully','user':{'username':user.username,'display_name':user.display_name,'wins':user.wins,'losses':user.losses,'is_online':user.is_online}},status=status.HTTP_200_OK)exceptCustomUser.DoesNotExist:returnResponse({'success':False,'message':'Usernotfound'},status=status.HTTP_404_NOT_FOUND)exceptExceptionase:returnResponse({'success':False,'message':str(e)},status=status.HTTP_500_INTERNAL_SERVER_ERROR)@api_view(['POST'])@permission_classes([IsAuthenticated])defsave_match_result(request):result=request.data.get('result')ifresultnotin['win','loss']:returnResponse({'error':'Invalidresult'},status=status.HTTP_400_BAD_REQUEST)MatchHistory.objects.create(user=request.user,result=result)returnResponse({'success':True},status=status.HTTP_201_CREATED)@api_view(['GET'])@permission_classes([IsAuthenticated])defget_recent_matches(request,username):try:user=CustomUser.objects.get(username=username)recent_matches=MatchHistory.objects.filter(user=user).order_by('-date')[:3]matches_data=[{'result':match.result,'date':match.date.strftime('%Y-%m-%d')}formatchinrecent_matches]returnResponse({'matches':matches_data})exceptCustomUser.DoesNotExist:returnResponse({'error':'Usernotfound'},status=status.HTTP_404_NOT_FOUND)exceptExceptionase:returnResponse({'error':str(e)},status=status.HTTP_500_INTERNAL_SERVER_ERROR)
===== ./ft_trans/pong/models.py =====
fromdjango.dbimportmodelsfromdjango.confimportsettingsfromdjango.contrib.auth.modelsimportAbstractBaseUser,PermissionsMixin,BaseUserManagerfromdjango.contrib.auth.hashersimportmake_password,check_passwordfromdjango.contrib.auth.validatorsimportUnicodeUsernameValidatorclassCustomUserManager(BaseUserManager):defcreate_user(self,username,password=None,**extra_fields):ifnotusername:raiseValueError('Lenomd’utilisateurestobligatoire')user=self.model(username=username,**extra_fields)user.set_password(password)user.save(using=self._db)returnuserdefcreate_superuser(self,username,password=None,**extra_fields):extra_fields.setdefault('is_superuser',True)returnself.create_user(username,password,**extra_fields)classCustomUser(AbstractBaseUser,PermissionsMixin):username=models.CharField(max_length=50,unique=True,validators=[UnicodeUsernameValidator()],verbose_name='nomd’utilisateur')email=models.CharField(max_length=100,verbose_name='adresseemail')display_name=models.CharField(max_length=50,unique=True)avatar_url=models.CharField(max_length=255,default='default_avatar.png',null=True)created_at=models.DateTimeField(auto_now_add=True)is_online=models.BooleanField(default=False)wins=models.IntegerField(default=0)losses=models.IntegerField(default=0)is_active=models.BooleanField(default=True)is_staff=models.BooleanField(default=False)objects=CustomUserManager()USERNAME_FIELD='username'REQUIRED_FIELDS=['email']classMeta:db_table='users'def__str__(self):returnself.usernamedefset_password(self,raw_password):self.password=make_password(raw_password)#Utilisezself.passwordaulieudeself.password_hashdefcheck_password(self,raw_password):returncheck_password(raw_password,self.password)#Utilisezself.passwordaulieudeself.password_hashclassUserToken(models.Model):user=models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE,related_name='tokens')token=models.TextField(unique=True)created_at=models.DateTimeField(auto_now_add=True)expiry_date=models.DateTimeField()def__str__(self):returnf"{self.user.username}-{self.token[:20]}..."classFriendship(models.Model):user=models.ForeignKey(settings.AUTH_USER_MODEL,related_name='friendships',on_delete=models.CASCADE)friend=models.ForeignKey(settings.AUTH_USER_MODEL,related_name='friend_of',on_delete=models.CASCADE)created_at=models.DateTimeField(auto_now_add=True)classMeta:unique_together=('user','friend')def__str__(self):returnf"{self.user.username}estamiavec{self.friend.username}"classFriendRequest(models.Model):from_user=models.ForeignKey(settings.AUTH_USER_MODEL,related_name='friend_requests_sent',on_delete=models.CASCADE)to_user=models.ForeignKey(settings.AUTH_USER_MODEL,related_name='friend_requests_received',on_delete=models.CASCADE)created_at=models.DateTimeField(auto_now_add=True)status=models.CharField(max_length=10,choices=[('pending','Pending'),('accepted','Accepted'),('rejected','Rejected')],default='pending')classMeta:unique_together=('from_user','to_user')def__str__(self):returnf"{self.from_user.username}->{self.to_user.username}({self.status})"classMatchHistory(models.Model):user=models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE,related_name='match_history')result=models.CharField(max_length=4,choices=[('win','Win'),('loss','Loss')])date=models.DateTimeField(auto_now_add=True)classMeta:ordering=['-date']def__str__(self):returnf"{self.user.username}-{self.result}-{self.date}"
===== ./ft_trans/pong/templates/index.html =====
{%loadstatic%}<!DOCTYPEhtml><htmllang="en"><head><linkrel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"><linkrel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"><style>@importurl('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');</style><metacharset="UTF-8"><metaname="viewport"content="width=device-width,initial-scale=1.0"><title>ft_transcendence</title><linkhref="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"rel="stylesheet"integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"crossorigin="anonymous"><linkrel="stylesheet"href="{%static'css/dashboard.css'%}"><linkrel="stylesheet"href="{%static'css/register.css'%}"><linkrel="stylesheet"href="{%static'css/login.css'%}"><linkrel="stylesheet"href="{%static'css/settings.css'%}"><linkrel="stylesheet"href="{%static'css/profile.css'%}"></head><body><divid="ft_transcendence"></div><script>varstaticUrl="{%static''%}";</script><scripttype="module"src="{%static'js/app.js'%}"></script><scriptsrc="https://cdn.jsdelivr.net/npm/chart.js"></script><scripttype="module"src="{%static'js/utils/unmask.js'%}"></script><scripttype="module"src="{%static'js/utils/friendManager.js'%}"></script><scripttype="module"src="{%static'js/views/login.js'%}"></script><scripttype="module"src="{%static'js/views/register.js'%}"></script><scripttype="module"src="{%static'js/views/settingsv.js'%}"></script><scripttype="module"src="{%static'js/views/dashboard.js'%}"></script><scripttype="module"src="{%static'js/app.js'%}"></script><scripttype="module"src="{%static'js/views/profile.js'%}"></script><scriptsrc="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script><scriptsrc="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script><scriptsrc="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script><scriptsrc="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script></body></html>
===== ./ft_trans/pong/templates/js/views/dashboard.js =====
import{navigateTo}from'../app.js';import{logout,setGlobalSocket}from'../utils/token.js';import{getSocket,initializeSocket}from'../utils/socketManager.js';import{fetchFriendList,sendFriendRequest,fetchFriendRequests,acceptFriendRequest,rejectFriendRequest}from'../utils/friendManager.js';import{getCookie}from'./settingsv.js';import{removeLoginEventListeners}from'./login.js';import{checkAuthentication}from'../utils/auth.js';import{showToast}from'../utils/unmask.js';import{checkFriendshipStatus}from'./profile.js';letsocket;constprivateChatLogs=newMap();constprivateMessages=newMap();//NouvelleMappourstockerlesmessagesconstusername=sessionStorage.getItem('username');exportasyncfunctiondashboard(player_name){constisAuthenticated=awaitcheckAuthentication();if(!isAuthenticated){navigateTo('/login');return;}removeLoginEventListeners();constusername=sessionStorage.getItem('username');constdisplayName=sessionStorage.getItem('display_name');letavatarUrl=sessionStorage.getItem('avatar_url');socket=initializeSocket(displayName);setupChatListeners(socket);if(!displayName){navigateTo('/login');return;}if(avatarUrl){avatarUrl=avatarUrl.replace(/^url\(["']?/,'').replace(/["']?\)$/,'');}document.getElementById('ft_transcendence').innerHTML=`<divclass="dashboard-container"><divclass="header"><aclass="navbar-brand"href="#"><imgsrc="${staticUrl}content/logo2.png"id="pongonlineLink"alt="Logo"class="logo"></a><spanclass="nav-item"style="font-size:2.5em;font-weight:bold;color:#ff7043;">${displayName}</span><divclass="profile-container"><imgsrc="${avatarUrl}"class="profile-icon"alt="ProfilePicture"id="img_profile_pic"style="cursor:pointer;"></div></div><divclass="content"><divclass="sidebar"><h2class="title-friends">Friends</h2><ulid="friends"class="list-group"></ul><divid="friendDropdown"class="dropdown-menu"style="display:none;"><aclass="dropdown-item"href="#"id="sendMessagePrivate">SendPrivateMessage</a><aclass="dropdown-item"href="#"id="startGame">StartaGame</a><aclass="dropdown-item"href="#"id="viewProfile">ViewProfile</a></div><divid="friendDropdown_chat"class="dropdown-menu_chat"style="display:none;"><aclass="dropdown-item"href="#"id="addToFriend">AddToFriend</a><aclass="dropdown-item"href="#"id="blockUser">BlockUser</a><aclass="dropdown-item"href="#"id="viewProfile">ViewProfile</a></div></div><divclass="game-container"><iframeid="pong"title="Pong"src="http://localhost:4000"></iframe></div><divclass="chat-container"><h2class="title-chat">Chat</h2><divclass="chat-log"id="chat-log"></div><divclass="input-container"><inputid="message-input"placeholder="Typeyourmessage..."rows="1"></input><buttonid="send-button">►</button></div></div></div><divid="profileDropdown"class="dropdown-menu"style="display:none;"><aclass="dropdown-item"href="#"id="viewmyProfile">MyProfile</a><aclass="dropdown-item"href="#"id="settings">Settings</a><aclass="dropdown-item"href="#"id="logoutLink">Logout</a></div><divclass="offcanvasoffcanvas-end"data-bs-scroll="true"tabindex="-1"id="chatbox"aria-labelledby="chatboxLabel"><divclass="offcanvas-header"><buttontype="button"class="btn-close"data-bs-dismiss="offcanvas"aria-label="Close"></button></div><divclass="offcanvas-body"><divid="private-chats-container"></div></div></div><divclass="toast-containerposition-fixedbottom-0end-0p-3"><divid="blockUserToast"class="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-header"><strongclass="me-auto">BlockUser</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">Userblockedsuccessfully!</div></div></div><footerid="footer-dashboard">©202442Company,Inc</footer></div>`;constiframe=document.getElementById('pong');iframe.onload=function(){constdisplayName=sessionStorage.getItem('display_name');consttoken=sessionStorage.getItem('accessToken');constcsrfToken=getCookie('csrftoken');console.log(sessionStorage);constavatar=sessionStorage.getItem('avatar_url');iframe.contentWindow.postMessage({username:displayName,token:token,csrfToken:csrfToken,avatar:avatar},'http://localhost:4000');};setupDashboardEvents(navigateTo,displayName);//setupChatListeners();checkForFriendRequests();fetchAndDisplayFriends();//loadGeneralChatMessages();}functionsetupChatListeners(socket){if(socket){console.log('===Settingupchatlisteners===');console.log('Socketstate:',{id:socket.id,connected:socket.connected,displayName:socket.displayName});socket.off('privatemessage');//Ajouterlenouveaulistenerpourlesmessagesprivéssocket.on('connect',()=>{console.log('Socketconnected');});socket.on('chatmessage',(msg)=>{console.log('===Chatmessagereceived===');console.log('Messagedata:',msg);receiveMessage(msg);});socket.on('privatemessage',(msg)=>{console.log('===Privatemessagereceived===');console.log('Messagedata:',msg);constcurrentUsername=sessionStorage.getItem('display_name');console.log('Currentuser:',currentUsername);console.log('Messageisforcurrentuser:',msg.to===currentUsername);console.log('Messageisfromcurrentuser:',msg.from===currentUsername);console.log('Messageisfrom:',msg.from);console.log('Messageisto:',msg.to);if(msg.to===currentUsername||msg.from===currentUsername){console.log('Processingprivatemessage');receivePrivateMessage(msg);}else{console.log('Messageignored-notforcurrentuser');}});}else{console.error('Setupfailed-Nosocketprovided');}}functionreceivePrivateMessage(msg){console.log('===Processingreceivedprivatemessage===');console.log('Messagedetails:',msg);constcurrentUser=sessionStorage.getItem('display_name');//Ajoutdevérificationspours'assurerquelespropriétésnécessairesexistentif(!msg.from){console.error('Messagereçusansexpéditeur(from)');return;}//Simsg.ton'existepas,onsupposequelemessageestpourl'utilisateurcourantletchatPartner;if(!msg.to){console.log('Messagereçusansdestinataire(to),utilisationdel\'expéditeurcommepartenaire');chatPartner=msg.from===currentUser?undefined:msg.from;}else{chatPartner=msg.from===currentUser?msg.to:msg.from;}console.log('Chatpartneridentification:',{currentUser,messageFrom:msg.from,messageTo:msg.to,identifiedPartner:chatPartner});if(!chatPartner){console.error('Impossibled\'identifierlepartenairedechat');return;}if(!privateChatLogs.has(chatPartner)){console.log('Settingupnewchatfor:',chatPartner);setupPrivateChat(chatPartner);}if(!privateMessages.has(chatPartner)){console.log('Initializingmessagearrayfor:',chatPartner);privateMessages.set(chatPartner,[]);}privateMessages.get(chatPartner).push({sender:msg.from,content:msg.message});constsenderDisplay=msg.from===currentUser?'Vous':msg.from;console.log('Displayingmessagefrom:',senderDisplay);displayPrivateMessage(chatPartner,senderDisplay,msg.message);}functiongenerateUniqueId(){returnDate.now().toString(36)+Math.random().toString(36).substr(2);}functionopenPrivateChat(friendName){letchatLog=privateChatLogs.get(friendName);if(!chatLog){chatLog=document.createElement('div');chatLog.id=`chat-log-${friendName}`;chatLog.className='chat-log';privateChatLogs.set(friendName,chatLog);}constchatContainer=document.getElementById('private-chats-container');chatContainer.innerHTML='';chatContainer.appendChild(chatLog);constinputContainer=document.createElement('div');inputContainer.className='input-container';inputContainer.innerHTML=`<inputtype="text"id="message-input-${friendName}"placeholder="Typeyourmessage..."><buttonid="send-button-${friendName}">Send</button>`;chatContainer.appendChild(inputContainer);document.getElementById(`send-button-${friendName}`).addEventListener('click',()=>sendPrivateMessage(friendName));}functionsetupDashboardEvents(navigateTo,username){//Logoutdocument.getElementById('logoutLink').addEventListener('click',handleLogout);//Friendmenudocument.querySelectorAll('#friends.list-group-item').forEach(item=>{item.addEventListener('click',handleFriendClick);});//Profilepicturedropdowndocument.getElementById('img_profile_pic').addEventListener('click',handleProfilePictureClick);//Hidethedropdownmenuwhenclickingoutsideofitdocument.addEventListener('click',hideDropdowns);//Preventthedropdownmenufromclosingwhenclickinginsideitdocument.getElementById('friendDropdown').addEventListener('click',(event)=>event.stopPropagation());document.getElementById('friendDropdown_chat').addEventListener('click',(event)=>event.stopPropagation());document.getElementById('profileDropdown').addEventListener('click',(event)=>event.stopPropagation());constdisplayName=sessionStorage.getItem('display_name');document.getElementById('viewmyProfile').addEventListener('click',(event)=>{event.preventDefault();navigateTo(`/profile/${displayName}`);});//Dropdownactionsdocument.getElementById('sendMessagePrivate').addEventListener('click',showChatbox);document.getElementById('startGame').addEventListener('click',startGame);document.getElementById('settings').addEventListener('click',goTosettings);//Chatfunctionnalitisdocument.getElementById('send-button').addEventListener('click',sendMessage);//SendmessagewhenpressingEnterkeydocument.addEventListener("keydown",handleEnterKey);//Viewprofiledocument.getElementById('friendDropdown').querySelector('#viewProfile').addEventListener('click',viewProfile);document.getElementById('friendDropdown_chat').querySelector('#viewProfile').addEventListener('click',viewProfile);//Friendactionsdocument.getElementById('friendDropdown_chat').querySelector('#addToFriend').addEventListener('click',addFriend);document.getElementById('friendDropdown_chat').querySelector('#blockUser').addEventListener('click',blockUser);//Profilepicture/////////////////////////////////////////////////////////////////////////////////////////////////////////////////toastwhenblockuserdocument.getElementById('friendDropdown_chat').querySelector('#blockUser').addEventListener('click',function(event){event.preventDefault();vartoast=newbootstrap.Toast(document.getElementById('blockUserToast'));toast.show();});if(window.location.pathname==='/dashboard'){setInterval(fetchAndDisplayFriends,20000);setInterval(checkForFriendRequests,20000);};}functionscrollToBottom2(friendName){constchatLog2=document.getElementById(`chat-log-${friendName}`);chatLog2.scrollTop=chatLog2.scrollHeight;}functionformatMessage(message){/*fornohtmlinjection*/if(message.startsWith("```")){return`<pre>${message}</pre>`;}/*syntax:[player_name]:message*/message=message.replace(/</g,"&lt;").replace(/>/g,"&gt;");message=message.replace(/(```[\s\S]*?```)/g,'<pre>$1</pre>');return`${message}`;}functionhandleProfilePictureClick(event){event.stopPropagation();constdropdown=document.getElementById('profileDropdown');//MasquertouslesdropdownsvisiblesconstvisibleDropdowns=document.querySelectorAll('.dropdown-menu,.dropdown-menu_chat');visibleDropdowns.forEach(dropdown=>{dropdown.style.display='none';});//Afficherledropdownpourlecalculersesdimensionsdropdown.style.display='block';//ObtenirlesdimensionsdelafenêtreetdudropdownconstwindowWidth=window.innerWidth;constwindowHeight=window.innerHeight;constdropdownRect=dropdown.getBoundingClientRect();//Calculerlapositionoptimalelettop=event.clientY;letleft=event.clientX;//Ajusterlapositionverticalesinécessaireif(top+dropdownRect.height>windowHeight){top=windowHeight-dropdownRect.height;}//Ajusterlapositionhorizontalesinécessaireif(left+dropdownRect.width>windowWidth){left=windowWidth-dropdownRect.width;}//Appliquerlanouvellepositiondropdown.style.top=`${top}px`;dropdown.style.left=`${left}px`;}functionhandleFriendClick(event){event.stopPropagation();constdropdown=document.getElementById('friendDropdown');constfriendName=this.getAttribute('data-friend');//HideallvisibledropdownsconstvisibleDropdowns=document.querySelectorAll('.dropdown-menu,.dropdown-menu_chat');visibleDropdowns.forEach(dropdown=>{dropdown.style.display='none';});//Positionthedropdownneartheclickedfrienditemdropdown.style.top=`${event.clientY}px`;dropdown.style.left=`${event.clientX}px`;dropdown.style.display='block';//Storetheclickedfriend'snamedropdown.setAttribute('data-friend',friendName);}functionhideDropdowns(){constdropdowns=document.querySelectorAll('.dropdown-menu,.dropdown-menu_chat');dropdowns.forEach(dropdown=>{dropdown.style.display='none';});}functionshowChatbox(event){event.preventDefault();constdropdown=event.target.closest('.dropdown-menu,.dropdown-menu_chat');if(dropdown){constfriendName=dropdown.getAttribute('data-friend');if(friendName){varchatbox=newbootstrap.Offcanvas(document.getElementById('chatbox'));chatbox.show();}else{console.error('Friendnamenotfound');}}else{console.error('Dropdownnotfound');}}functionsetupPrivateChat(friendName){if(privateChatLogs.has(friendName)){console.log(`Chatprivédéjàconfigurépour${friendName}`);return;}constprivateChatContainer=document.getElementById('private-chats-container');privateChatContainer.innerHTML=`<h5class="offcanvas-title"id="chatboxLabel">Messageprivé:${friendName}</h5><divclass="chat-container2"><divclass="chat-log2"id="chat-log-${friendName}"></div></div><divclass="input-container2"><inputtype="text"id="message-input-${friendName}"placeholder="Tapezvotremessage..."><buttonid="send-button-${friendName}">►</button></div>`;//Restaurerlesmessagesprécédentsif(privateMessages.has(friendName)){constmessages=privateMessages.get(friendName);messages.forEach(msg=>{displayPrivateMessage(friendName,msg.sender,msg.content);});}constsendButton=document.getElementById(`send-button-${friendName}`);sendButton.addEventListener('click',()=>{sendPrivateMessage(friendName);document.getElementById(`message-input-${friendName}`).value='';});//CréeruneconnexionprivéepourcechatcreatePrivateConnection(friendName);//console.log(`Connexionprivéecrééeentre${sanitizeHTML(friendName)}et${sanitizeHTML(sessionStorage.getItem('display_name'))}`);console.log(`Connexionprivéecrééeentre${friendName}et${sessionStorage.getItem('display_name')}`);}functioncreatePrivateConnection(friendName){constdisplayName=sessionStorage.getItem('display_name');constsocket=getSocket(displayName);//UtiliserdisplayNameconsole.log(`Socket:${socket.id}`);console.log(`Friendname:${friendName}`);if(socket){socket.emit('createprivateroom',{friend:friendName});}}functionsendPrivateMessage(friendName){console.log('===StartingsendPrivateMessage===');console.log(`Attemptingtosendmessageto:${friendName}`);constinput=document.getElementById(`message-input-${friendName}`);if(!input){console.error(`Inputelementnotfoundforfriend:${friendName}`);return;}constmessage=input.value.trim();constcurrentUser=sessionStorage.getItem('display_name');constsocket=getSocket(currentUser);if(message&&socket&&socket.connected){constsanitizedMessage=sanitizeHTML(message);constmessageData={to:friendName,from:currentUser,message:sanitizedMessage,time:Date.now()};console.log('Emittingsocketmessagewithdata:',messageData);socket.emit('privatemessage',messageData);displayPrivateMessage(friendName,'Vous',sanitizedMessage);input.value='';}}//FonctiondesanitizationfunctionsanitizeHTML(str){vartemp=document.createElement('div');temp.textContent=str;returntemp.innerHTML;}functiondisplayPrivateMessage(friendName,sender,message){constchatLog=document.getElementById(`chat-log-${friendName}`);if(chatLog){constmessageElement=document.createElement('div');messageElement.classList.add('message-container');constusernameElement=document.createElement('span');usernameElement.classList.add('username-link');usernameElement.textContent=sender==='Vous'?`[Me]`:`[${sanitizeHTML(friendName)}]`;constmessageTextElement=document.createElement('span');messageTextElement.classList.add('message-text');messageTextElement.textContent=sanitizeHTML(message);messageElement.appendChild(usernameElement);messageElement.appendChild(document.createTextNode(':'));messageElement.appendChild(messageTextElement);chatLog.appendChild(messageElement);chatLog.scrollTop=chatLog.scrollHeight;}}functionstartGame(event){event.preventDefault();//needapiforcheckiffriendisalreadyingameorintournamentorinqueue//createatoasttodisplaytheerroriffriendisalreadyingameorintournamentorinqueuewithshowToastfunctionconstfriendName=document.getElementById('friendDropdown').getAttribute('data-friend');showToast(`${friendName}isalreadyingameorintournamentorinqueue`,'Impossibletostartagamewiththisuser');}functiongoTosettings(event){event.preventDefault();console.log('Gotosettings');navigateTo('/settings');}functionsendMessage(event){event.preventDefault();constdisplayName=sessionStorage.getItem('display_name');constmessageInput=document.getElementById('message-input');constmessage=messageInput.value.trim();constsocket=getSocket(displayName);console.log(`sendMessagefunctioncalled`);console.log(`Socketconnected:${socket.connected}`);console.log(`Socketid:${socket.id}`);console.log(`EndofsendMessagefunction`);if(message!==''&&socket&&socket.connected){socket.emit('chatmessage',{name:displayName,message:message});saveMessage(displayName,message);messageInput.value='';getSocket(displayName);}}functionreceiveMessage(msg){console.log('FonctionreceiveMessageappeléeavec:',msg);constchatLog=document.getElementById('chat-log');if(!chatLog){console.error("L'élémentchat-logn'existepasdansleDOM");return;}constmessageElement=document.createElement('div');constusernameElement=document.createElement('span');usernameElement.classList.add('username-link');usernameElement.dataset.friend=msg.name;usernameElement.innerText=`[${msg.name}]`;usernameElement.style="cursor:pointer;";//saveMessage(msg.name,msg.message);usernameElement.addEventListener('click',function(event){event.preventDefault();event.stopPropagation();constcurrentUsername=sessionStorage.getItem('username');constisOwnUsername=msg.name===currentUsername;constdropdown=isOwnUsername?document.getElementById('profileDropdown'):document.getElementById('friendDropdown_chat');constfriendName=this.dataset.friend;usernameElement.classList.add('username-link','bold-username');//MasquertouslesmenusdéroulantsvisiblesconstvisibleDropdowns=document.querySelectorAll('.dropdown-menu,.dropdown-menu_chat');visibleDropdowns.forEach(dropdown=>{dropdown.style.display='none';});if(dropdown){dropdown.style.position='fixed';dropdown.style.display='block';//Vérifiersiledropdowndépasselafenêtreconstrect=dropdown.getBoundingClientRect();constwindowWidth=window.innerWidth;constwindowHeight=window.innerHeight;if(event.clientY+rect.height>windowHeight){dropdown.style.top=`${event.clientY-rect.height}px`;}else{dropdown.style.top=`${event.clientY}px`;}if(event.clientX+rect.width>windowWidth){dropdown.style.left=`${event.clientX-rect.width}px`;}else{dropdown.style.left=`${event.clientX}px`;}dropdown.dataset.friend=friendName;}console.log('Messagereçu:',msg);});constmessageTextElement=document.createElement('span');messageTextElement.innerText=`:${msg.message}`;messageElement.appendChild(usernameElement);messageElement.appendChild(messageTextElement);chatLog.appendChild(messageElement);chatLog.scrollTop=chatLog.scrollHeight;}functionhandleEnterKey(event){if(event.key==="Enter"){constoffcanvas=document.querySelector('.offcanvas.offcanvas-end.show');if(offcanvas){constfriendName=offcanvas.querySelector('.offcanvas-title').textContent.split(':')[1];constmessageInput=document.getElementById(`message-input-${friendName}`);if(messageInput&&document.activeElement===messageInput){constsendButton=document.getElementById(`send-button-${friendName}`);if(sendButton){sendButton.click();}else{sendPrivateMessage(friendName);}messageInput.value='';}}else{constmessageInput=document.getElementById('message-input');if(messageInput&&document.activeElement===messageInput){sendMessage(event);}}}}functionaddFriend(event){event.preventDefault();constdropdown=event.target.closest('.dropdown-menu,.dropdown-menu_chat');constfriendName=dropdown?dropdown.getAttribute('data-friend'):null;if(!friendName){console.error("Unabletodeterminefriend'sname");return;}//Vérifierlestatutd'amitiéavantd'envoyerunedemandecheckFriendshipStatus(friendName).then(({isFriend,requestSent})=>{if(isFriend){showToast('Alreadyfriends','info');return;}if(requestSent){showToast('Friendrequestalreadysent','info');return;}//Sipasamisetaucunedemandeencours,envoyerunedemanded'amisendFriendRequest(friendName).then(response=>{if(!response.ok){returnresponse.json().then(data=>{thrownewError(data.message||`ErreurHTTP:${response.status}`);});}returnresponse.json();}).then(data=>{console.log('Friendrequestsentsuccessfully',data);showToast('Friendrequestsentsuccessfully','success');}).catch(error=>{console.error('Errorsendingfriendrequest:',error);showToast(error.message,'error');});}).catch(error=>{console.error('Errorcheckingfriendshipstatus:',error);showToast('Errorcheckingfriendshipstatus','error');});}functionshowFriendRequestSentToast(friendName){consttoastHtml=`<divclass="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-header"><strongclass="me-auto">FriendRequestSent</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">Friendrequestsentto${friendName}successfully!</div></div>`;consttoastContainer=document.createElement('div');toastContainer.className='toast-containerposition-fixedtop-0start-50translate-middle-xp-3';toastContainer.innerHTML=toastHtml;document.body.appendChild(toastContainer);consttoastElement=toastContainer.querySelector('.toast');consttoast=newbootstrap.Toast(toastElement);toast.show();}functionblockUser(event){event.preventDefault();constfriendName=document.getElementById('friendDropdown').getAttribute('data-friend');console.log(`Block${friendName}`);}functionviewProfile(event){event.preventDefault();constdropdown=event.target.closest('.dropdown-menu,.dropdown-menu_chat');constfriendName=dropdown?dropdown.getAttribute('data-friend'):null;if(friendName){console.log(`Viewprofileof${friendName}`);navigateTo(`/profile/${encodeURIComponent(friendName)}`);}else{console.error("Unabletodeterminefriend'sname");}}functionsaveMessage(friendName,message){letmessages=JSON.parse(sessionStorage.getItem('general_chat_messages'))||[];messages.push({friendName,message,timestamp:newDate().toISOString()});if(messages.length>15){messages=messages.slice(-15);}sessionStorage.setItem('general_chat_messages',JSON.stringify(messages));}functionloadGeneralChatMessages(){constchatLog=document.getElementById('chat-log');if(!chatLog){console.error("L'élémentchat-logn'existepasdansleDOM");return;}constmessages=JSON.parse(sessionStorage.getItem('general_chat_messages'))||[];chatLog.innerHTML='';//Effacerlesmessagesprécédentsmessages.forEach(msg=>{constmessageElement=document.createElement('div');constusernameElement=document.createElement('span');usernameElement.classList.add('username-link');usernameElement.dataset.friend=msg.name;usernameElement.innerText=`[${msg.name}]`;usernameElement.style.cursor="pointer";usernameElement.classList.add('bold-username');//Ajouterl'écouteurd'événementspourleclicsurlenomd'utilisateurusernameElement.addEventListener('click',function(event){event.preventDefault();event.stopPropagation();handleUsernameClick(event,msg.name);});constmessageTextElement=document.createElement('span');messageTextElement.innerText=`:${msg.message}`;messageElement.appendChild(usernameElement);messageElement.appendChild(messageTextElement);chatLog.appendChild(messageElement);});chatLog.scrollTop=chatLog.scrollHeight;}functionhandleUsernameClick(event,username){constcurrentUsername=sessionStorage.getItem('username');constisOwnUsername=username===currentUsername;constdropdown=isOwnUsername?document.getElementById('profileDropdown'):document.getElementById('friendDropdown_chat');//MasquertouslesmenusdéroulantsvisiblesconstvisibleDropdowns=document.querySelectorAll('.dropdown-menu,.dropdown-menu_chat');visibleDropdowns.forEach(dropdown=>{dropdown.style.display='none';});if(dropdown){dropdown.style.position='fixed';dropdown.style.display='block';//Vérifiersiledropdowndépasselafenêtreconstrect=dropdown.getBoundingClientRect();constwindowWidth=window.innerWidth;constwindowHeight=window.innerHeight;if(event.clientY+rect.height>windowHeight){dropdown.style.top=`${event.clientY-rect.height}px`;}else{dropdown.style.top=`${event.clientY}px`;}if(event.clientX+rect.width>windowWidth){dropdown.style.left=`${event.clientX-rect.width}px`;}else{dropdown.style.left=`${event.clientX}px`;}dropdown.dataset.friend=username;}}functioncheckForFriendRequests(){fetchFriendRequests().then(friendRequests=>{console.log('Donnéesdesdemandesd\'ami:',friendRequests);friendRequests.forEach(request=>{showFriendRequestToast(request.from_username,request.id);});}).catch(error=>console.error('Erreurlorsdelarécupérationdesdemandesd\'ami:',error));}functionshowFriendRequestToast(fromUsername,requestId){consttoastHtml=`<divclass="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-header"style="background-color:#FF8C00;"><strongclass="me-auto"style="color:#ff5722;background-color:white;">FriendRequest</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body"style="color:black;background-color:white;">${fromUsername}wantstoaddyouasafriend.<divclass="mt-2pt-2border-top"><buttontype="button"class="btnbtn-primarybtn-smaccept-friend-request"data-request-id="${requestId}"style="background-color:#FF8C00;">Accept</button><buttontype="button"class="btnbtn-primarybtn-smreject-friend-request"data-request-id="${requestId}"style="background-color:#FF8C00;">Reject</button></div></div></div>`;consttoastContainer=document.createElement('div');toastContainer.className='toast-containerposition-fixedtop-0start-50translate-middle-xp-3';toastContainer.innerHTML=toastHtml;document.body.appendChild(toastContainer);consttoastElement=toastContainer.querySelector('.toast');consttoast=newbootstrap.Toast(toastElement);//Ajoutezlesécouteursd'événementspourlesboutonstoastElement.querySelector('.accept-friend-request').addEventListener('click',function(){acceptFriendRequest(this.dataset.requestId).then(()=>{toast.hide();fetchAndDisplayFriends();}).catch(error=>console.error('Erreurlorsdel\'acceptationdelademanded\'ami:',error));});toastElement.querySelector('.reject-friend-request').addEventListener('click',function(){rejectFriendRequest(this.dataset.requestId).then(()=>{toast.hide();}).catch(error=>console.error('Erreurlorsdurejetdelademanded\'ami:',error));});toast.show();}asyncfunctionfetchAndDisplayFriends(){//iflistgroupfriendsexisttryelsereturnconstfriendsList=document.getElementById('friends');if(friendsList){try{constresponse=awaitfetch('/api/friends/',{method:'GET',headers:{'Authorization':`Bearer${sessionStorage.getItem('accessToken')}`,'Content-Type':'application/json'}});constdata=awaitresponse.json();console.log('DonnéesreçuesparfetchAndDisplayFriends:',data);constfriendsList=document.getElementById('friends');friendsList.innerHTML='';data.friends.forEach(friend=>{constli=document.createElement('li');li.className='list-group-itemd-flexjustify-content-betweenalign-items-center';li.setAttribute('data-friend',friend.username);conststatusDot=document.createElement('span');statusDot.className=`status-dot${friend.is_online?'online':'offline'}`;constusernameSpan=document.createElement('span');usernameSpan.textContent=friend.display_name||friend.username;li.appendChild(statusDot);li.appendChild(usernameSpan);li.addEventListener('click',handleFriendClick);friendsList.appendChild(li);if(friend.is_online){//checkifprivatechatalreadyexistif(!privateChatLogs.has(friend.display_name)){setupPrivateChat(friend.display_name);}}});}catch(error){console.error('Erreurlorsdelarécupérationdesamis:',error);}}}functionreinitializeSocket(){constusername=sessionStorage.getItem('username');if(username&&!socket){socket=initializeSocket(username);setupChatListeners(socket);}}////AppelezreinitializeSocketauchargementdelapage//window.addEventListener('load',reinitializeSocket);functionshowFriendDropdown(event,friendName){constdropdown=document.getElementById('friendDropdown');dropdown.setAttribute('data-friend',friendName);dropdown.style.display='block';//Positionnerledropdownprèsducurseurdropdown.style.left=`${event.clientX}px`;dropdown.style.top=`${event.clientY}px`;}functionupdateFriendStatus(friendName,isOnline){constfriendItem=document.querySelector(`#friendsli[data-friend="${friendName}"]`);if(friendItem){conststatusDot=friendItem.querySelector('.status-dot');statusDot.className=`status-dot${isOnline?'online':'offline'}`;}}//Ajouterunécouteurpourlesmouvementsdesourisetlesfrappesauclavierdocument.addEventListener('mousemove',resetActivityTimer);document.addEventListener('keypress',resetActivityTimer);functionresetActivityTimer(){constdisplayName=sessionStorage.getItem('display_name');if(displayName){getSocket(displayName);//UtiliserdisplayName}}//quandjedeconnecte,jeveuxqueleseventlistenersoitsupprimer//document.addEventListener('click',logout);exportfunctionremoveDashboardEventListeners(){//RemovelogoutlistenerconstlogoutLink=document.getElementById('logoutLink');if(logoutLink){logoutLink.removeEventListener('click',handleLogout);}//RemovefrienditemlistenersconstfriendItems=document.querySelectorAll('#friends.list-group-item');friendItems.forEach(item=>{item.removeEventListener('click',handleFriendClick);});//RemoveprofilepicturelistenerconstprofilePic=document.getElementById('img_profile_pic');if(profilePic){profilePic.removeEventListener('click',handleProfilePictureClick);}//Removeotherlistenersdocument.removeEventListener('click',hideDropdowns);document.removeEventListener('keydown',handleEnterKey);//ClearintervalsclearInterval(window.fetchFriendsInterval);clearInterval(window.checkFriendRequestsInterval);//RemovesocketlistenersconstdisplayName=sessionStorage.getItem('display_name');constsocket=getSocket(displayName);if(socket){socket.off('chatmessage');socket.off('privatemessage');socket.off('force_disconnect');socket.off('user_disconnected');}console.log('removeDashboardEventListeners');}//ModifytheexistinglogoutfunctionfunctionhandleLogout(event){event.preventDefault();constdisplayName=sessionStorage.getItem('display_name');constsocket=getSocket(displayName);if(socket){socket.disconnect();}removeDashboardEventListeners();logout();}functiondebugPrintMaps(){console.log('===DebugMapsState===');console.log('privateChatLogsMap:');privateChatLogs.forEach((value,key)=>{console.log(`Key:${key}`);console.log('Value:',value);});console.log('\nprivateMessagesMap:');privateMessages.forEach((messages,friend)=>{console.log(`Friend:${friend}`);console.log('Messages:',messages);});console.log('=====================\n');}
===== ./ft_trans/pong/templates/js/views/login.js =====
import{navigateTo}from'../app.js';import{getCsrfToken}from'../utils/token.js';import{removeDashboardEventListeners}from'./dashboard.js';exportfunctionlogin(){removeDashboardEventListeners();//Addthislineconsole.log('loginview');document.getElementById('ft_transcendence').innerHTML=`<divclass="containerlogin-container"><imgsrc="${staticUrl}content/logo_400_400.png"id="logo_pong_login"alt="Logo"width="200"height="200"><formid="loginForm"><p><labelfor="username"style="color:#ff5722;margin-top:10px;">Accountname</label><inputtype="text"placeholder="EnterAccountname"id="username"></p><p><labelfor="password"style="color:#ff5722;">Password</label><divclass="password-wrapper"><inputtype="password"placeholder="EnterPassword"id="password"class="password"><buttonclass="unmask"type="button"title="Mask/Unmaskpasswordtocheckcontent"><iclass="fasfa-lock"></i></button></div></p><buttontype="submit"class="btnbtn-primary"id="login_button"style="margin-top:40px;">Login</button><buttontype="submit"class="btnbtn-primary"id="login_with_42"style="background-color:#FF8C00;">Loginwith42</button><div><divclass="text-center"><buttontype="button"id="create_account"style="margin-top:10px;"class="btnbtn-outline-light">Createaccount</button></div></div></form></div><divclass="position-fixedtop-0start-50translate-middle-xp-3"style="z-index:11"><divid="loginToast"class="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-headerbg-dangertext-white"><strongclass="me-auto">LoginError</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">Invalidusernameorpassword</div></div><divid="successToast"class="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-headerbg-successtext-white"><strongclass="me-auto">Success</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">Operationsuccessful</div></div></div><footer><p>©202442Company,Inc</p></footer>`;//UtilisersetTimeoutpours'assurerqueleDOMestcomplètementmisàjoursetTimeout(()=>{attachEventLoginPage();checkRegistrationSuccess();},0);}functionattachEventLoginPage(){constloginForm=document.getElementById('loginForm');if(loginForm){loginForm.addEventListener('submit',handleLogin);}constcreateButton=document.getElementById('create_account');if(createButton){createButton.addEventListener('click',function(event){event.preventDefault();navigateTo('/register');});}//Remplacerl'anciengestionnaired'événementspourunmaskconstunmaskButtons=document.querySelectorAll('.unmask');unmaskButtons.forEach(button=>{button.addEventListener('click',handleUnmaskPassword);});document.addEventListener("keydown",handleEnterKeyPress);document.getElementById('login_with_42').addEventListener('click',function(event){event.preventDefault();console.log('"Loginwith42"buttonclicked');window.location.href='/api/auth/42/login/';});}functionhandleUnmaskPassword(event){constbutton=event.currentTarget;constinput=button.previousElementSibling;if(input.type==='password'){input.type='text';button.querySelector('i').classList.remove('fa-lock');button.querySelector('i').classList.add('fa-lock-open');}else{input.type='password';button.querySelector('i').classList.remove('fa-lock-open');button.querySelector('i').classList.add('fa-lock');}}functionhandleEnterKeyPress(event){if(event.key==="Enter"){constloginForm=document.getElementById('loginForm');if(loginForm){loginForm.dispatchEvent(newEvent('submit'));}}}asyncfunctionhandleLogin(event){event.preventDefault();constusername=document.getElementById('username').value;constpassword=document.getElementById('password').value;try{constcsrfToken=awaitgetCsrfToken();console.log("CSRFtokenobtenu:",csrfToken);constresponse=awaitfetch('/api/login/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken,},body:JSON.stringify({username,password}),credentials:'include',});constdata=awaitresponse.json();if(data.success){console.log('Connexionréussie');sessionStorage.setItem('accessToken',data.access);sessionStorage.setItem('refreshToken',data.refresh);sessionStorage.setItem('username',data.username);sessionStorage.setItem('display_name',data.display_name);sessionStorage.setItem('avatar_url',data.avatar_url);navigateTo('/dashboard');//Mettezàjourlestatutenligneawaitfetch('/api/update-online-status/',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer${data.access}`,},});}else{console.error('Échecdelaconnexion:',data.message);showLoginToastErr(data.message);}}catch(error){console.error('Erreur:',error);showLoginToastErr('Uneerreurestsurvenue.Veuillezréessayer.');}}asyncfunctionhandle42Login(){consturlParams=newURLSearchParams(window.location.search);constauthSuccess=urlParams.get('auth_success');consterror=urlParams.get('error');if(authSuccess==='true'){try{constresponse=awaitfetch('/api/auth/42/login/callback/'+window.location.search);constdata=awaitresponse.json();if(data.success){sessionStorage.setItem('accessToken',data.access);sessionStorage.setItem('refreshToken',data.refresh);sessionStorage.setItem('username',data.username);sessionStorage.setItem('display_name',data.display_name);sessionStorage.setItem('avatar_url',data.avatar_url);navigateTo('/dashboard');}else{showLoginToastErr(data.error||'Échecdelaconnexion');}}catch(error){console.error('Erreurlorsdelaconnexionavec42:',error);showLoginToastErr('Uneerreurestsurvenue.Veuillezréessayer.');}}elseif(error){showLoginToastErr(decodeURIComponent(error));}}functionshowLoginToastErr(message){consttoastEl=document.getElementById('loginToast');consttoast=newbootstrap.Toast(toastEl);consttoastBody=toastEl.querySelector('.toast-body');toastBody.textContent=message;toast.show();}functioncheckRegistrationSuccess(){constsuccessMessage=sessionStorage.getItem('registrationSuccess');consturlParams=newURLSearchParams(window.location.search);constauthSuccess=urlParams.get('auth_success');if(successMessage){showSuccessToast(successMessage);sessionStorage.removeItem('registrationSuccess');}elseif(authSuccess==='true'){showSuccessToast('42registrationsuccessful.Youcannowlogin.');history.replaceState(null,'',window.location.pathname);}}functionshowSuccessToast(message){consttoastEl=document.getElementById('successToast');consttoastBody=toastEl.querySelector('.toast-body');toastBody.textContent=message;consttoast=newbootstrap.Toast(toastEl);toast.show();}functionshowLoginToast(message){consttoastEl=document.getElementById('loginToast');consttoastBody=toastEl.querySelector('.toast-body');toastBody.textContent=message;consttoast=newbootstrap.Toast(toastEl);toast.show();}exportfunctionremoveLoginEventListeners(){constloginForm=document.getElementById('loginForm');if(loginForm){loginForm.removeEventListener('submit',handleLogin);}constcreateButton=document.getElementById('create_account');if(createButton){createButton.removeEventListener('click',navigateTo);}document.removeEventListener('click',handleUnmaskPassword);document.removeEventListener("keydown",handleEnterKeyPress);}
===== ./ft_trans/pong/templates/js/views/profile.js =====
import{navigateTo}from'../app.js';import{logout}from'../utils/token.js';import{fetchWithToken}from'../utils/api.js';import{sendFriendRequest,fetchFriendList}from'../utils/friendManager.js';import{getCookie}from'./settingsv.js';import{removeDashboardEventListeners}from'./dashboard.js';exportasyncfunctioncheckFriendshipStatus(username){try{constresponse=awaitfetchWithToken(`/api/check-friend-request/${username}/`);if(!response.ok){thrownewError(`ErreurHTTP!statut:${response.status}`);}constdata=awaitresponse.json();console.log('RésultatdecheckFriendshipStatus:',data);return{isFriend:data.is_friend,requestSent:data.request_sent};}catch(error){console.error('Erreurlorsdelavérificationdustatutd\'amitié:',error);return{isFriend:false,requestSent:false};}}asyncfunctiongetRecentMatches(username){try{constresponse=awaitfetchWithToken(`/api/get-recent-matches/${username}/`);if(!response.ok){consterrorText=awaitresponse.text();console.error('Réponsed\'erreur:',errorText);}constdata=awaitresponse.json();console.log('Recentmatches:',data);returndata.matches;}catch(error){console.error('Errorfetchingrecentmatches:',error);return[];}}exportasyncfunctionprofile(displayName){console.log('fetchprofileof',displayName);removeDashboardEventListeners();try{console.log(`Attemptingtoretrieveprofilefor${displayName}`);constresponse=awaitfetchWithToken(`/api/user/${displayName}/`);//VérifierletypedecontenudelaréponseconstcontentType=response.headers.get("content-type");if(contentType&&contentType.indexOf("application/json")!==-1){if(!response.ok){thrownewError(`HTTPerror!status:${response.status}`);}constdata=awaitresponse.json();console.log('Userprofile:',data);if(!data.success){thrownewError(data.error||'Uneerreurestsurvenuelorsdelarécupérationduprofil');}constuserProfile=data.user;if(userProfile.avatar_url){userProfile.avatar_url=userProfile.avatar_url.replace(/^url\(["']?/,'').replace(/["']?\)$/,'');}consttotalGames=userProfile.wins+userProfile.losses;console.log(`Gettingrecentmatchesfor${userProfile.username}`);constrecentMatches=awaitgetRecentMatches(userProfile.username);console.log('Recentmatches:',recentMatches);constmatchHistory=recentMatches.length>0?recentMatches.map(match=>({result:match.result.charAt(0).toUpperCase()+match.result.slice(1),date:match.date})):[];document.getElementById('ft_transcendence').innerHTML=`<divclass="dashboard-container"><h3id="header-dashboard"style="margin-top:10px;"class="text-center">${userProfile.display_name}'sProfile</h3><divclass="text-center"id="profile-picture"><imgsrc="${userProfile.avatar_url}"class="img-thumbnailrounded-circled-flexjustify-content-center"alt="Profilepicture"></div><divclass="status-indicatortext-centermt-2"><spanclass="status-dot${userProfile.is_online?'online':'offline'}"></span><spanclass="status-text">${userProfile.is_online?'Online':'Offline'}</span></div><buttontype="button"id="friendButton"class="btn-dark">Addasfriend</button><divclass="rowmt-4"><divclass="col-md-4"><divclass="card"><divclass="card-bodconsole.log('Userprofile:',userProfile);y"><h5class="card-title">PlayerStatistics</h5><pclass="card-text"><strong>Wins:</strong>${userProfile.wins}<br><strong>Losses:</strong>${userProfile.losses}<br><strong>Totalgames:</strong>${totalGames}<br></p></div></div></div><divclass="col-md-4"><divclass="card"><divclass="card-body"><h5class="card-title">Win/LossRatio</h5><divid="chartContainer"style="height:200px;width:100%;"><canvasid="winLossChart"></canvas></div></div></div></div><divclass="col-md-4"><divclass="card"><divclass="card-body"><h5class="card-title">RecentMatchHistory</h5><ulclass="list-grouplist-group-flush">${matchHistory.map(match=>`<liclass="list-group-itemd-flexjustify-content-betweenalign-items-center${match.result.toLowerCase()==='win'?'win':'loss'}"><spanclass="match-result${match.result.toLowerCase()}">${match.result}</span><spanclass="badgerounded-pill">${match.date}</span></li>`).join('')}</ul></div></div></div></div><divclass="text-centermt-4"><buttonid="backToDashboard"style="width:200px;"class="btnbtn-primary">BacktoDashboard</button></div><footerclass="py-3my-4"><pclass="text-centertext-body-secondary">©202442Company,Inc</p></footer></div>`;const{isFriend,requestSent}=awaitcheckFriendshipStatus(userProfile.username);attachEventHandlers2(navigateTo,userProfile.username,isFriend,requestSent);createWinLossChart(userProfile.wins,userProfile.losses);document.getElementById('backToDashboard').addEventListener('click',()=>{navigateTo('/dashboard');});}else{consttext=awaitresponse.text();console.error('Receivednon-JSONresponse:',text);thrownewError("Receivednon-JSONresponse");}}catch(error){console.error('Error:',error);document.getElementById('ft_transcendence').innerHTML=`<divclass="d-flexflex-columnalign-items-centerjustify-content-centervh-100"><divclass="alertalert-dangertext-center"role="alert">Errorloadingprofile.Pleasetryagainlater.(${error.message})</div><divclass="mt-3"><buttonid="backToDashboard"style="width:200px;"class="btnbtn-primary">BacktoDashboard</button></div></div>`;document.getElementById('backToDashboard').addEventListener('click',()=>{navigateTo('/dashboard');});}}functionattachEventHandlers2(navigateTo,friendName,isFriend,requestSent){constfriendButton=document.getElementById('friendButton');constcurrentUser=sessionStorage.getItem('username');functionupdateFriendButton(){if(friendName===currentUser){friendButton.innerText="It'sme";friendButton.classList.add('btn-dark','disabled');}elseif(isFriend){friendButton.innerText='AlreadyFriends';friendButton.classList.add('btn-dark','disabled');}elseif(requestSent){friendButton.innerText='RequestSent';friendButton.classList.add('btn-dark','disabled');}else{friendButton.innerText='AddFriend';friendButton.classList.remove('disabled');}}friendButton.addEventListener('click',()=>{if(friendName!==currentUser&&!isFriend&&!requestSent){sendFriendRequest(friendName).then(()=>{requestSent=true;updateFriendButton();}).catch(error=>console.error('Erreurlorsdel\'envoidelademanded\'ami:',error));}});updateFriendButton();}functioncreateWinLossChart(wins,losses){constctx=document.getElementById('winLossChart').getContext('2d');//Détruirelegraphiqueexistants'ilyenaunif(window.winLossChartinstanceofChart){window.winLossChart.destroy();}consttotalGames=wins+losses;constnoGamesPlayed=totalGames===0;window.winLossChart=newChart(ctx,{type:'doughnut',data:{labels:['Wins','Losses'],datasets:[{data:noGamesPlayed?[1,1]:[wins,losses],backgroundColor:['#4CAF50','#F44336'],borderColor:'#121212',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'bottom',labels:{color:'#ff5722',font:{size:14}}},tooltip:{callbacks:{label:function(context){if(noGamesPlayed){return'Nogamesplayed';}letlabel=context.label||'';if(label){label+=':';}if(context.parsed!==null){label+=context.parsed+'games';}returnlabel;}}}},cutout:'50%'}});}
===== ./ft_trans/pong/templates/js/views/settingsv.js =====
import{navigateTo}from'../app.js';constplayer_name=sessionStorage.getItem('player_name');exportfunctionsettings(){constdisplayName=sessionStorage.getItem('displayName');letavatarUrl=sessionStorage.getItem('avatar_url');if(avatarUrl){avatarUrl=avatarUrl.replace(/^url\(["']?/,'').replace(/["']?\)$/,'');}if(!displayName){navigateTo('/login');return;}console.log('settingsview');document.getElementById('ft_transcendence').innerHTML=`<divclass="dashboard-container"><ulclass="navjustify-content-betweenalign-items-center"><aclass="navbar-brand"href="#"><imgsrc="${staticUrl}content/logo2.png"id="pongonlineLink"alt="Logo"width="70"height="70"></a><liclass="nav-item"><spanclass="nav-item"style="font-size:2.5em;font-weight:bold;">${displayName}</span></li><liclass="nav-item"><imgsrc="${avatarUrl}"class="img-thumbnailrounded-circled-flexjustify-content-center"alt="Photodeprofil"style="width:50px;height:50px;padding:0px;"></li></ul><h3id="header-dashboard"class="text-centersettings-title">UserSettings</h3><divclass="containermt-4settings-form-container"><formid="settingsForm"><divclass="mb-3"><labelfor="displayName"class="form-label">DisplayName</label><inputtype="text"class="form-control"id="displayName"name="displayName"></div><divclass="mb-3"><labelfor="email"class="form-label">Email</label><inputtype="email"class="form-control"id="email"name="email"></div><divclass="mb-3"><labelfor="avatar"class="form-label">Avatar</label><divclass="d-flexalign-items-center"><imgid="currentAvatar"src="${avatarUrl}"alt="Avataractuel"class="img-thumbnailrounded-circleme-3avatar-img"style="width:100px;height:100px;padding:0px;border:1pxsolid#ff5722;"><inputtype="file"class="form-control"id="avatar"name="avatar"accept="image/jpeg,image/png,image/gif"></div><smallclass="form-texttext-muted"><ul><li><istyle="color:#ff5722;">Acceptedformats:JPG,PNG,GIF</i></li><li><istyle="color:#ff5722;">Maximumsize:5MB</i></li><li><istyle="color:#ff5722;">Dimensions:between100x100and1000x1000pixels</i></li></ul></small></div><buttontype="submit"class="btnbtn-primary">Savechanges</button></form><buttonid="backToDashboard"class="btnbtn-secondary">BacktoDashboard</button></div><footerclass="footerpy-3my-4"><pclass="text-center">©202442Company,Inc</p></footer><divclass="toast-containerposition-fixedtop-0start-50translate-middle-xp-3"style="z-index:11;"><divid="saveSettingsToast"class="toast"><divclass="toast-header"><strongclass="me-auto">SettingsSaved!</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">Yourprofilesettingshavebeensuccessfullyupdated.</div></div><divid="savePasswordToast"class="toast"><divclass="toast-header"><strongclass="me-auto">PasswordSaved!</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">Yourpasswordhasbeensuccessfullyupdated.</div></div></div></div>`;attachEventSettingsPage(navigateTo,player_name);}functionattachEventSettingsPage(navigateTo,player_name){constpongonlineLink=document.getElementById('pongonlineLink');constbackToDashboard=document.getElementById('backToDashboard');constsettingsForm=document.getElementById('settingsForm');constchangePasswordForm=document.getElementById('changePasswordForm');constavatarInput=document.getElementById('avatar');pongonlineLink.addEventListener('click',(event)=>{event.preventDefault();navigateTo('/dashboard');});backToDashboard.addEventListener('click',()=>navigateTo('/dashboard'));settingsForm.addEventListener('submit',async(event)=>{event.preventDefault();constformData=newFormData(settingsForm);try{constcsrftoken=getCookie('csrftoken');constresponse=awaitfetch('/api/update-user-settings/',{method:'POST',body:formData,headers:{'Authorization':`Bearer${sessionStorage.getItem('accessToken')}`,'X-CSRFToken':csrftoken,},});if(response.ok){showUpdateProfileToast();constdisplayName=document.getElementById('displayName').value;constemail=document.getElementById('email').value;constavatarFile=document.getElementById('avatar').files[0];if(displayName!==player_name){sessionStorage.setItem('player_name',displayName);}if(email!==sessionStorage.getItem('email')){sessionStorage.setItem('email',email);}if(avatarFile){constreader=newFileReader();reader.onload=(e)=>{sessionStorage.setItem('avatar_url',e.target.result);};reader.readAsDataURL(avatarFile);}}else{consterrorData=awaitresponse.json();showToast(`Erreur:${errorData.message}`,'error');}}catch(error){console.error('Erreurlorsdelamiseàjourdesparamètres:',error);showToast('Uneerreurestsurvenuelorsdelamiseàjourdesparamètres.','error');}});avatarInput.addEventListener('change',(event)=>{constfile=event.target.files[0];if(file){//Vérificationdelatailledufichierif(file.size>5*1024*1024){showToast('Fileistoolarge.Maximumsizeis5MB.','error');avatarInput.value='';return;}//VérificationdutypedefichierconstacceptedTypes=['image/jpeg','image/png','image/gif'];if(!acceptedTypes.includes(file.type)){showToast('Filetypenotaccepted.PleasechooseaJPG,PNGorGIFimage.','error');avatarInput.value='';return;}constreader=newFileReader();reader.onload=(e)=>{constimg=newImage();img.onload=()=>{if(img.width<100||img.height<100||img.width>1000||img.height>1000){showToast('Imagedimensionsmustbebetween100x100and1000x1000pixels.','error');avatarInput.value='';}else{document.getElementById('currentAvatar').src=e.target.result;}};img.src=e.target.result;};reader.readAsDataURL(file);}});//Pre-fillformfieldsdocument.getElementById('displayName').value=player_name;document.getElementById('email').value='newmail@example.com';}functionshowUpdateProfileToast(){consttoastEl=document.getElementById('saveSettingsToast');consttoast=newbootstrap.Toast(toastEl);toast.show();}functionshowsavePasswordToast(){consttoastEl=document.getElementById('savePasswordToast');consttoast=newbootstrap.Toast(toastEl);toast.show();}exportfunctiongetCookie(name){letcookieValue=null;if(document.cookie&&document.cookie!==''){constcookies=document.cookie.split(';');for(leti=0;i<cookies.length;i++){constcookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}returncookieValue;}functionshowToast(message,type='info'){consttoastHtml=`<divclass="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-header"><strongclass="me-auto">${type.charAt(0).toUpperCase()+type.slice(1)}</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body">${message}</div></div>`;consttoastContainer=document.createElement('div');toastContainer.className='toast-containerposition-fixedtop-0start-50translate-middle-xp-3';toastContainer.innerHTML=toastHtml;document.body.appendChild(toastContainer);consttoastElement=toastContainer.querySelector('.toast');consttoast=newbootstrap.Toast(toastElement);toast.show();}
===== ./ft_trans/pong/templates/js/views/notfound.js =====
import{navigateTo}from'../app.js';exportfunctionnotFound(){constcontent=`<divclass="d-flexflex-columnalign-items-centerjustify-content-centervh-100"><divclass="alertalert-dangertext-center"role="alert"style="background-color:#ff5722;color:white;"><h4class="alert-heading">404:PageNotFound</h4><p>Thepageyouarelookingfordoesnotexist.</p></div><divclass="mt-3"><buttonid="backToLogin"style="width:200px;"class="btnbtn-primary">BacktoLogin</button></div></div>`;document.getElementById('ft_transcendence').innerHTML=content;document.getElementById('backToLogin').addEventListener('click',()=>{navigateTo('/login');});}
===== ./ft_trans/pong/templates/js/views/register.js =====
import{navigateTo}from'../app.js';import{getCsrfToken}from'../utils/token.js';import{showToast}from'../utils/unmask.js';exportfunctionregister(){document.getElementById('ft_transcendence').innerHTML=`<divclass="containerregister-container"><h1class="register-title"style="margin-top:5%;">CreateYourAccount</h1><formid="registerForm"><divstyle="display:flex;justify-content:center;align-items:center;"><labelfor="username"class="form-label">Accountname</label></div><divclass="form-group"><inputtype="text"id="username"placeholder="Enteryouraccountname"requiredclass="form-input"style="width:450px;margin:0auto;display:block;"></div><divstyle="display:flex;justify-content:center;align-items:center;"><labelfor="email"class="form-label">Email</label></div><divclass="form-group"><inputtype="email"id="email"placeholder="Enteryouremail"requiredclass="form-input"style="width:450px;margin:0auto;display:block;"></div><divstyle="display:flex;justify-content:center;align-items:center;"><labelfor="password"class="form-label">Password</label></div><divclass="form-grouppassword-group"style="width:450px;margin:0auto;display:block;"><divclass="password-wrapper"><inputtype="password"id="password"placeholder="Enteryourpassword"requiredclass="form-input"><buttonclass="unmask"type="button"title="Mask/Unmaskpasswordtocheckcontent"><iclass="fasfa-lock"></i></button></div></div><divstyle="display:flex;justify-content:center;align-items:center;"><labelfor="confirmPassword"class="form-label">ConfirmPassword</label></div><divclass="form-grouppassword-group"style="width:450px;margin:0auto;display:block;"><divclass="password-wrapper"><inputtype="password"id="confirmPassword"placeholder="Confirmyourpassword"requiredclass="form-input"><buttonclass="unmask"type="button"title="Mask/Unmaskpasswordtocheckcontent"><iclass="fasfa-lock"></i></button></div></div><divstyle="display:flex;justify-content:center;align-items:center;"><labelfor="avatar"class="form-label">ChooseyourAvatar</label></div><divclass="form-group"><divclass="choose-avatar"><divclass="avatars-container"><spanclass="left"></span><divclass="avatars"><divclass="avatar-item"style="background-image:url('https://i.ibb.co/C2WLdyY/avatar1.png');"><spanid="text-avatar">Choose</span></div><divclass="avatar-item"style="background-image:url('https://i.ibb.co/0t3JTMz/avatar2.png');"><spanid="text-avatar">Choose</span></div><divclass="avatar-item"style="background-image:url('https://i.ibb.co/K08BjJx/avatar3.png');"><spanid="text-avatar">Choose</span></div><divclass="avatar-item"style="background-image:url('https://i.ibb.co/6XW1X2L/avatar4.png');"><spanid="text-avatar">Choose</span></div><divclass="avatar-item"style="background-image:url('https://i.ibb.co/DVfTxB2/avatar5.png');"><spanid="text-avatar">Choose</span></div><divclass="avatar-item"style="background-image:url('https://i.ibb.co/Bzvqgg3/avatar6.png');"><spanid="text-avatar">Choose</span></div><divclass="avatar-item"style="background-image:url('https://i.ibb.co/FDg3t8m/avatar7.png');"><spanid="text-avatar">Choose</span></div></div><spanclass="right"></span></div></div></div><divclass="form-actions"><buttonid="registerbutton"type="submit"class="btn-primary">Register</button><buttonid="registerbutton42"type="button"class="btn-secondary"style="background-color:#FF8C00;">Registerwith42</button></div></form><buttonid="arrowbackregister"class="btn-back"style="width:450px;margin:10pxauto0;display:block;">Back</button></div><footerclass="footer"><p>©202442Company,Inc</p></footer>`;//UtilisersetTimeoutpours'assurerqueleDOMestcomplètementmisàjoursetTimeout(()=>{setupRegisterEvents(navigateTo);},0);}functionsetupRegisterEvents(navigateTo){document.getElementById('registerForm').addEventListener('submit',asyncfunction(event){event.preventDefault();constusername=document.getElementById('username').value;constemail=document.getElementById('email').value;constpassword=document.getElementById('password').value;constconfirmPassword=document.getElementById('confirmPassword').value;if(password!==confirmPassword){showToast('Passwordsdonotmatch.Pleasetryagain.','error');return;}constselectedAvatar=document.querySelector('.avatar-item.current').style.backgroundImage;console.log('Registeringuser:',username,email,password,selectedAvatar);try{constcsrfToken=awaitgetCsrfToken();console.log('CSRFtoken:',csrfToken);constresponse=awaitfetch('/api/register/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken,},body:JSON.stringify({username:username,email:email,password:password,avatar_url:selectedAvatar}),credentials:'include',});constdata=awaitresponse.json();if(data.success){sessionStorage.setItem('accessToken',data.access);sessionStorage.setItem('refreshToken',data.refresh);showToast('Accountcreatedsuccessfully.Pleaselogin.','success');navigateTo('/login');}else{showToast(data.error,'error');}}catch(error){console.error('Error:',error);showToast('Anerroroccurredduringregistration:'+error.message,'error');}});document.getElementById('arrowbackregister').addEventListener('click',function(event){event.preventDefault();navigateTo('/login');});constprev=document.querySelector('.left');constnext=document.querySelector('.right');constcontainer=document.querySelector('.avatars');constavatars=document.querySelectorAll('.avatars-container.avatar-item');letcurrentIndex=Math.floor(avatars.length/2);constval=(avatars.length-1-Math.floor(avatars.length/2))*195;lettranslateVal=0;for(leti=0;i<avatars.length;i++){if(i===Math.floor(avatars.length/2)){avatars[i].classList.add('current');}avatars[i].addEventListener('click',()=>{//Logiquedesélectiond'avataravatars.forEach(av=>av.classList.remove('current'));avatars[i].classList.add('current');});}letdefaultVal=0;if(avatars.length%2===0){defaultVal=90;translateVal-=90;container.style.transform=`translateX(${translateVal}px)`;}prev.addEventListener('click',()=>{if(currentIndex-1<0){avatars[currentIndex].classList.remove('current');avatars[avatars.length-1].classList.add('current');currentIndex=avatars.length-1;translateVal=-val-defaultVal;container.style.transform=`translateX(${translateVal}px)`;}else{avatars[currentIndex].classList.remove('current');avatars[currentIndex-1].classList.add('current');currentIndex-=1;translateVal+=195;container.style.transform=`translateX(${translateVal}px)`;}});next.addEventListener('click',()=>{if(currentIndex+1>=avatars.length){avatars[currentIndex].classList.remove('current');avatars[0].classList.add('current');currentIndex=0;translateVal=val+defaultVal;container.style.transform=`translateX(${translateVal}px)`;}else{avatars[currentIndex].classList.remove('current');avatars[currentIndex+1].classList.add('current');currentIndex+=1;translateVal-=195;container.style.transform=`translateX(${translateVal}px)`;}});document.getElementById('registerbutton42').addEventListener('click',function(event){event.preventDefault();window.location.href='/api/auth/42/';});constunmaskButtons=document.querySelectorAll('.unmask');unmaskButtons.forEach(button=>{button.addEventListener('click',handleUnmaskPassword);});}functionhandleUnmaskPassword(event){constbutton=event.currentTarget;constinput=button.previousElementSibling;if(input.type==='password'){input.type='text';button.querySelector('i').classList.remove('fa-lock');button.querySelector('i').classList.add('fa-lock-open');}else{input.type='password';button.querySelector('i').classList.remove('fa-lock-open');button.querySelector('i').classList.add('fa-lock');}}
===== ./ft_trans/pong/templates/js/game/index.html =====
<!DOCTYPEhtml><htmllang="en"><head><metacharset="utf-8"><title>ft_transcendence</title><linkrel="stylesheet"href="style.css"></head><body><buttonid="start-game-button"class="start-game-button">START</button><divid="menu"class="menuhidden"><buttonclass="menu-buttonhidden"id="solo-ia">Solo</button><buttonclass="menu-buttonhidden"id="multi-button">Multiplayer</button></div><divid="multi"class="multihidden"><buttonclass="menu-button"id="multi-2-local">2PlayersLocal</button><buttonclass="menu-button"id="multi-2-online">2PlayersOnline</button><buttonclass="menu-button"id="multi-four">4PlayersOnline</button><buttonclass="menu-button"id="multi-tournament">Tournaments</button><buttonclass="menu-button"id="multi-back-button">Back</button></div><divid="tournament"class="tournamenthidden"><ulid="tournament-list"></ul><buttonclass="menu-button"id="create-tournament">Createtournament</button><buttonclass="menu-button"id="tournament-back-button">Back</button></div><divid="tournament-details"class="hidden"><divclass="colonne"><spanid="player-1"></span><divclass="ligne"><spanid="player-2"></span></div><spanid="player-3"></span><divclass="ligne"><spanid="player-4"></span></div></div><divclass="colonne"><spanid="Gagnant-1"></span><divclass="ligne"><spanid="Gagnant-2"></span></div></div><divclass="colonne"><spanid="Gagnant-Finale"></span></div><buttonclass="button-tournament"id="quit-tournament">QuitTournament</button></div><divid="match-info"class="hidden"></div><divid="space"class="hidden"><h1>PressspacetoLaunchthegame</h1></div><divid="waiting"class="waitinghidden"><p>Waitingforplayers...</p><divid="spinner"></div></div><divid="score"class="hidden"><divid="scoreLeft">0</div><divid="scoreTitle">SCORE</div><divid="scoreRight">0</div></div><divid="game-over"class="game-overhidden"><divid="winner-message"></div><buttonclass="menu-button"id="back-to-menu-button">Back</button></div><divid="credits"><h1>CREDITS</h1></div><script>document.addEventListener('DOMContentLoaded',()=>{conststartButton=document.getElementById('start-game-button');constmenu=document.getElementById('menu');constsoloIaButton=document.getElementById('solo-ia');constmultiButton=document.getElementById('multi-button');constmultiMenu=document.getElementById('multi');consttournament=document.getElementById('tournament');consttournamentDetails=document.getElementById('tournament-details');constwaiting=document.getElementById('waiting');//AfficherleboutonStartGame//startButton.classList.add('hidden');tournamentDetails.classList.add('hidden');tournamentDetails.classList.remove('flex');/*document.getElementById('score').classList.remove('score-container');*///Lorsqu'oncliquesurStartGame,lemenuprincipalapparaît/*startButton.addEventListener('click',()=>{menu.classList.remove('hidden');startButton.classList.add('hidden');soloIaButton.classList.remove('hidden');multiButton.classList.remove('hidden');});*///GestionduboutonSolovsIAsoloIaButton.addEventListener('click',()=>{menu.classList.add('hidden');});//GestionduboutonMultijoueurmultiButton.addEventListener('click',()=>{menu.classList.add('hidden');multiMenu.classList.remove('hidden');});//GestionduboutonRetourdepuislemenuMultijoueurdocument.getElementById('multi-back-button').addEventListener('click',()=>{multiMenu.classList.add('hidden');menu.classList.remove('hidden');});//GestionduboutonTournoisdocument.getElementById('multi-tournament').addEventListener('click',()=>{multiMenu.classList.add('hidden');tournament.classList.remove('hidden');});//GestionduboutonRetourdepuislemenuTournoisdocument.getElementById('tournament-back-button').addEventListener('click',()=>{tournament.classList.add('hidden');multiMenu.classList.remove('hidden');});//GestionduboutonCréeruntournoidocument.getElementById('create-tournament').addEventListener('click',()=>{tournament.classList.add('hidden');tournamentDetails.classList.remove('hidden');tournamentDetails.classList.add('flex');});document.getElementById('quit-tournament').addEventListener('click',()=>{tournament.classList.remove('hidden');tournamentDetails.classList.add('hidden');tournamentDetails.classList.remove('flex');});//Gestiondumodemultijoueurlocaldocument.getElementById('multi-2-local').addEventListener('click',()=>{multiMenu.classList.add('hidden');});//Gestiondumodemultijoueurenlignedocument.getElementById('multi-2-online').addEventListener('click',()=>{multiMenu.classList.add('hidden');waiting.classList.remove('hidden');});//Gestiondumode4joueursenlignedocument.getElementById('multi-four').addEventListener('click',()=>{multiMenu.classList.add('hidden');waiting.classList.remove('hidden');});});</script><scriptsrc="./node_modules/socket.io/client-dist/socket.io.js"></script><scripttype="module"src="/main.mjs"></script></body></html>
===== ./ft_trans/pong/templates/js/utils/unmask.js =====
exportfunctionshowToast(message,type='success'){consttoastHtml=`<divclass="toast"role="alert"aria-live="assertive"aria-atomic="true"><divclass="toast-header"><strongclass="me-auto">${type.charAt(0).toUpperCase()+type.slice(1)}</strong><buttontype="button"class="btn-close"data-bs-dismiss="toast"aria-label="Close"></button></div><divclass="toast-body"style="background-color:#FF8C00;">${message}</div></div>`;consttoastContainer=document.createElement('div');toastContainer.className='toast-containerposition-fixedtop-0start-50translate-middle-xp-3';toastContainer.innerHTML=toastHtml;document.body.appendChild(toastContainer);consttoastElement=toastContainer.querySelector('.toast');consttoast=newbootstrap.Toast(toastElement);toast.show();}
===== ./ft_trans/pong/templates/js/utils/socketManager.js =====
import{fetchWithToken}from'./api.js';letsockets=newMap();letactivityTimers=newMap();exportfunctioninitializeSocket(username){if(sockets.has(username)&&sockets.get(username).connected){console.log('Socketdéjàinitialisépourcetutilisateur');resetActivityTimer(username);returnsockets.get(username);}if(!username){console.error('Nomd\'utilisateurnontrouvé');returnnull;}constsocket=io('http://localhost:3000',{transports:['websocket'],query:{username:username}});socket.username=username;socket.on('connect',()=>{console.log(`Connectedtochatserverfor${username}`);socket.emit('register',username);resetActivityTimer(username);});socket.on('disconnect',()=>{console.log(`Disconnectedfromchatserverfor${username}`);sockets.delete(username);clearActivityTimer(username);updateOnlineStatus(username,false);});socket.on('connect_error',(error)=>{console.error(`Connectionerrorfor${username}:`,error);});sockets.set(username,socket);console.log(`Socket:${socket}linkedto${username}`);resetActivityTimer(username);returnsocket;}functionresetActivityTimer(username){clearActivityTimer(username);activityTimers.set(username,setTimeout(()=>{console.log(`Inactivitydetectedfor${username}`);updateOnlineStatus(username,false);},120000));//2minutes}functionclearActivityTimer(username){if(activityTimers.has(username)){clearTimeout(activityTimers.get(username));activityTimers.delete(username);}}asyncfunctionupdateOnlineStatus(username,isOnline){try{constresponse=awaitfetchWithToken('/api/update-online-status/',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({is_online:isOnline}),});if(!response.ok){thrownewError('Errorupdatingonlinestatus');}console.log(`Onlinestatusupdatedfor${username}:${isOnline}`);}catch(error){console.error('Errorupdatingonlinestatus:',error);}}exportfunctiongetSocket(username){resetActivityTimer(username);returnsockets.get(username);}exportfunctiondisconnectSocket(username){constsocket=sockets.get(username);if(socket){socket.disconnect();sockets.delete(username);}}
===== ./ft_trans/pong/templates/js/utils/server.js =====
constexpress=require('express');consthttp=require('http');constsocketIo=require('socket.io');constcors=require('cors');constfetch=require('node-fetch');constuserConnections=newMap();constapp=express();constserver=http.createServer(app);constio=socketIo(server,{cors:{origin:"*",methods:["GET","POST"],credentials:true}});//FonctionpourformaterladatefunctionformatDate(date){constday=date.getDate().toString().padStart(2,'0');constmonth=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][date.getMonth()];constyear=date.getFullYear();consthours=date.getHours().toString().padStart(2,'0');constminutes=date.getMinutes().toString().padStart(2,'0');constseconds=date.getSeconds().toString().padStart(2,'0');return`{[${day}/${month}/${year}${hours}:${minutes}:${seconds}]}`;}//UtiliserlemiddlewareCORSapp.use(cors());app.get('/',(req,res)=>{res.send('Socket.ioserverisrunning');});constusers=newMap();io.on('connection',(socket)=>{console.log('Unutilisateurs\'estconnecté:',socket.id);socket.on('register',(username)=>{if(username){userConnections.set(username,{socketId:socket.id,lastActivity:Date.now()});if(!users.has(username)){socket.username=username;users.set(username,socket.id);console.log(`${formatDate(newDate())}Utilisateurenregistré:${username}`);}else{console.log(`${formatDate(newDate())}L'utilisateur${username}estdéjàconnecté`);//Déconnecterl'anciensocketsinécessaireconstexistingSocketId=users.get(username);constexistingSocket=io.sockets.sockets.get(existingSocketId);if(existingSocket){existingSocket.disconnect();}socket.username=username;users.set(username,socket.id);console.log(`${formatDate(newDate())}Utilisateur${username}reconnectéaveclenouveausocket${socket.id}`);}}else{console.error(`${formatDate(newDate())}Tentatived'enregistrementavecunnomd'utilisateurinvalide`);}});socket.on('chatmessage',(msg)=>{console.log(`${formatDate(newDate())}Messagereçude${msg.name}:${msg.message}`);io.emit('chatmessage',msg);updateLastActivity(msg.name);});socket.on('createprivateroom',(data)=>{console.log(`Créationdelasalleprivéepour${socket.username}et${data.friend}`);constroomName=[socket.username,data.friend].sort().join('-');socket.join(roomName);constfriendSocket=users.get(data.friend);if(friendSocket){io.to(friendSocket).emit('privateroomcreated',{friend:socket.username});}socket.emit('privateroomcreated',{friend:data.friend});console.log(`Salleprivéecréée:${roomName}`);});socket.on('privatemessage',({to,message})=>{console.log(`${formatDate(newDate())}Messageprivéde${socket.username}à${to}:${message}`);constrecipientSocketId=users.get(to);if(recipientSocketId){constroomName=[socket.username,to].sort().join('-');console.log(`${formatDate(newDate())}Messageprivéde${socket.username}à${to}danslasalle${roomName}:${message}`);io.to(roomName).emit('privatemessage',{from:socket.username,message:message});}else{socket.emit('error',{message:`${to}n'estpasenligne.`});}});//Gestiondeserreursglobalessocket.on('error',(data)=>{console.error('Erreurserveur:',data.message);});socket.on('disconnect',async()=>{console.log(`${formatDate(newDate())}Unutilisateurs'estdéconnecté:${socket.id}`);constusername=[...userConnections.entries()].find(([_,value])=>value.socketId===socket.id)?.[0];if(username){userConnections.delete(username);users.delete(username);io.emit('user_disconnected',username);try{constresponse=awaitfetch('http://localhost:8000/api/update-online-status/',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer${process.env.SERVER_TOKEN}`},body:JSON.stringify({is_online:false})});if(!response.ok){thrownewError(`HTTPerror!status:${response.status}`);}console.log(`${formatDate(newDate())}Statutmisàjourpour${username}:offline`);}catch(error){console.error(`${formatDate(newDate())}Erreurlorsdelamiseàjourdustatutpour${username}:`,error.message);}}});});functionupdateLastActivity(username){if(userConnections.has(username)){userConnections.get(username).lastActivity=Date.now();}}//Vérifierl'inactivitétouteslesminutessetInterval(()=>{console.log('Vérificationdel\'inactivité');constnow=Date.now();userConnections.forEach((value,username)=>{if(now-value.lastActivity>120000){//2minutesconstsocket=io.sockets.sockets.get(value.socketId);if(socket){socket.disconnect(true);}console.log(`${formatDate(newDate())}Déconnexiondel'utilisateur${username}pourinactivité`);userConnections.delete(username);io.emit('user_disconnected',username);}});},60000);//Vérifierchaqueminuteserver.listen(3000,()=>{console.log(`${formatDate(newDate())}Serveurenécoutesurleport3000`);});
===== ./ft_trans/pong/templates/js/utils/api.js =====
import{getCookie}from'../views/settingsv.js';exportasyncfunctionfetchWithToken(url,options={}){consttoken=sessionStorage.getItem('accessToken');constcsrfToken=getCookie('csrftoken');constheaders={...options.headers,'Authorization':`Bearer${token}`,'Content-Type':'application/json','Accept':'application/json','X-CSRFToken':csrfToken,};//console.log('En-têtesdelarequête:',headers);console.log('fetching:',url);console.log('method:',options.method);constmethod=options.method||'GET';constresponse=awaitfetch(url,{...options,method,headers});returnresponse;}
===== ./ft_trans/pong/templates/js/utils/token.js =====
import{navigateTo}from'../app.js';import{getCookie}from'../views/settingsv.js';//DéclarezunevariableglobalepourstockerlaréférenceausocketletglobalSocket;//FonctionpourdéfinirlesocketglobalexportfunctionsetGlobalSocket(socket){globalSocket=socket;}functionrefreshToken(){returnfetch('http://localhost:8000/api/token/refresh/',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({refresh:sessionStorage.getItem('refreshToken')}),}).then(response=>response.json()).then(data=>{if(data.access){sessionStorage.setItem('accessToken',data.access);returntrue;}else{returnfalse;}}).catch(()=>false);}exportasyncfunctiongetCsrfToken(){constresponse=awaitfetch('/api/set-csrf-token/',{method:'GET',credentials:'include',});if(response.ok){constdata=awaitresponse.json();returndata.csrfToken;}thrownewError('FailedtogetCSRFtoken');}exportfunctiongenerateToken(){returnfetch('http://localhost:8000/api/token/',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({username:'admin',password:'admin',}),}).then(response=>response.json()).then(data=>{if(data.access&&data.refresh){sessionStorage.setItem('accessToken',data.access);sessionStorage.setItem('refreshToken',data.refresh);returntrue;}else{returnfalse;}}).catch(()=>false);}exportasyncfunctionlogout(){//Déconnexiondusocketsiilexisteif(globalSocket&&globalSocket.connected){globalSocket.disconnect();console.log('Utilisateurdéconnectédusocket');}try{awaitfetch('/api/update-online-status/',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer${sessionStorage.getItem('accessToken')}`,},body:JSON.stringify({is_online:false}),});}catch(error){console.error('Erreurlorsdelamiseàjourdustatutenligne:',error);}sessionStorage.removeItem('accessToken');sessionStorage.removeItem('refreshToken');sessionStorage.removeItem('username');sessionStorage.removeItem('display_name');sessionStorage.removeItem('avatar_url');sessionStorage.removeItem('csrfToken');document.cookie='';document.removeEventListener('c',logout);navigateTo('/login');}exportasyncfunctionrefreshAccessToken(){constrefreshToken=sessionStorage.getItem('refreshToken');if(!refreshToken){console.log('Aucunrefreshtokendisponible.');logout();returnfalse;}try{constresponse=awaitfetch('/api/token/refresh/',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({refresh:refreshToken}),});constdata=awaitresponse.json();if(data.access){sessionStorage.setItem('accessToken',data.access);returntrue;}else{logout();returnfalse;}}catch(error){console.error('Erreurlorsdurafraîchissementdutoken :',error);logout();returnfalse;}}setInterval(refreshAccessToken,50*60*1000);
===== ./ft_trans/pong/templates/js/utils/auth.js =====
exportasyncfunctioncheckAuthentication(){consttoken=sessionStorage.getItem('accessToken');if(!token){returnfalse;}try{constresponse=awaitfetch('/api/verify-token/',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer${token}`},});if(response.ok){returntrue;}else{sessionStorage.removeItem('accessToken');returnfalse;}}catch(error){console.error('Erreurlorsdelavérificationdutoken:',error);returnfalse;}}
===== ./ft_trans/pong/templates/js/utils/friendManager.js =====
import{fetchWithToken}from'./api.js';exportfunctionfetchFriendList(){returnfetchWithToken('/api/friends/').then(response=>response.json()).catch(error=>{console.error('Erreurlorsdelarécupérationdelalisted\'amis:',error);throwerror;});}//Fonctionpourenvoyerunedemanded'amiexportfunctionsendFriendRequest(toUsername){returnfetchWithToken('/api/send-friend-request/',{method:'POST',body:JSON.stringify({to_username:toUsername})});}//Fonctionpourrécupérerlesdemandesd'amienattenteexportfunctionfetchFriendRequests(){returnfetchWithToken('/api/get-friend-requests/').then(response=>response.json()).then(data=>{if(data.success){returndata.friend_requests;}else{thrownewError(data.message||'Erreurlorsdelarécupérationdesdemandesd\'ami');}});}//Fonctionpouraccepterunedemanded'amiexportfunctionacceptFriendRequest(requestId){returnfetchWithToken('/api/accept-friend-request/',{method:'POST',body:JSON.stringify({request_id:requestId})}).then(response=>response.json()).then(data=>{if(data.success){console.log('Demanded\'amiacceptée');returndata;}else{thrownewError(data.message||'Erreurlorsdel\'acceptationdelademanded\'ami');}});}//Fonctionpourrejeterunedemanded'amiexportfunctionrejectFriendRequest(requestId){returnfetchWithToken('/api/reject-friend-request/',{method:'POST',body:JSON.stringify({request_id:requestId})}).then(response=>response.json()).then(data=>{if(data.success){console.log('Demanded\'amirejetée');returndata;}else{thrownewError(data.message||'Erreurlorsdurejetdelademanded\'ami');}});}
===== ./ft_trans/pong/templates/js/app.js =====
import{login,removeLoginEventListeners}from'./views/login.js';import{register}from'./views/register.js';import{dashboard}from'./views/dashboard.js';import{profile}from'./views/profile.js';import{settings}from'./views/settingsv.js';import{notFound}from'./views/notfound.js';import{initializeSocket,disconnectSocket}from'./utils/socketManager.js';import{getCookie}from'./views/settingsv.js';import{removeDashboardEventListeners}from'./views/dashboard.js';//Déclarationderoutercommeunevariableglobaleaumoduleletrouter;functioninitRouter(){router=function(){constpath=window.location.pathname;//ListedesroutesprotégéesconstprotectedRoutes=['/dashboard','/settings','/profile/*'];//Vérifiersil'utilisateurtented'accéderàunerouteprotégéesansêtreconnectéconsole.log('isUserLoggedIn:',isUserLoggedIn());if(protectedRoutes.includes(path)&&!isUserLoggedIn()){console.log('Accèsnonautorisé.Redirectionverslapagedeconnexion.');navigateTo('/login');return;}if(path.startsWith('/profile/')&&isUserLoggedIn()){constfriendName=decodeURIComponent(path.split('/').pop());console.log('friendname:',friendName);profile(friendName);}elseif(path==='/profile'){//Gérerlecasoùl'URLestsimplement/profileconsole.log('Accèsauprofildel\'utilisateurconnecté');constusername=sessionStorage.getItem('username');profile(username);//Afficherleprofildel'utilisateurconnecté}else{switch(path){case'/':login();break;case'/login':if(isUserLoggedIn()){navigateTo('/dashboard');}else{login();}break;case'/dashboard':dashboard();break;case'/register':if(isUserLoggedIn()){navigateTo('/dashboard');}else{register();}break;case'/settings':settings();break;default:notFound();console.log('404:Pagenotfound');}}};window.addEventListener('popstate',router);//Gestionnairepourlesclicssurlesliensdocument.body.addEventListener('click',e=>{if(e.target.matches('[data-link]')){e.preventDefault();navigateTo(e.target.getAttribute('href'));}});//Initialroutecallrouter();}exportfunctionnavigateTo(pathname){constprotectedRoutes=['/dashboard','/settings','/profile/*'];if(protectedRoutes.includes(pathname)&&!isUserLoggedIn()){console.log('Accèsnonautorisé.Redirectionverslapagedeconnexion.');removeDashboardEventListeners();pathname='/login';}constfullPath=window.location.origin+pathname;window.history.pushState({},pathname,fullPath);router();document.dispatchEvent(newCustomEvent('viewChanged'));}document.addEventListener('DOMContentLoaded',initRouter);functionisUserLoggedIn(){returnsessionStorage.getItem('username')!==null;}//ExportezégalementinitRoutersivousenavezbesoinailleursexport{initRouter};
===== ./ft_trans/pong/apps.py =====
fromdjango.appsimportAppConfigclassPongConfig(AppConfig):default_auto_field='django.db.models.BigAutoField'name='pong'
===== ./ft_trans/pong/admin.py =====
fromdjango.contribimportadminfrom.modelsimportCustomUseradmin.site.register(CustomUser)
